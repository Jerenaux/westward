/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/ 		}
/******/ 	};
/******/
/******/ 	// define __esModule on exports
/******/ 	__webpack_require__.r = function(exports) {
/******/ 		if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 			Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 		}
/******/ 		Object.defineProperty(exports, '__esModule', { value: true });
/******/ 	};
/******/
/******/ 	// create a fake namespace object
/******/ 	// mode & 1: value is a module id, require it
/******/ 	// mode & 2: merge all properties of value into the ns
/******/ 	// mode & 4: return value when already ns object
/******/ 	// mode & 8|1: behave like require
/******/ 	__webpack_require__.t = function(value, mode) {
/******/ 		if(mode & 1) value = __webpack_require__(value);
/******/ 		if(mode & 8) return value;
/******/ 		if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/ 		var ns = Object.create(null);
/******/ 		__webpack_require__.r(ns);
/******/ 		Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/ 		if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/ 		return ns;
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = "./client/main.js");
/******/ })
/************************************************************************/
/******/ ({

/***/ "./client/BigButton.js":
/*!*****************************!*\
  !*** ./client/BigButton.js ***!
  \*****************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _UI__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./UI */ \"./client/UI.js\");\n/**\r\n * Created by Jerome Renaux (jerome.renaux@gmail.com) on 14-02-18.\r\n */\r\n\r\n\r\n\r\nfunction BigButton(x,y,text,callback,bigger){\r\n    this.slices = [];\r\n    var sideWidth = 22;\r\n\r\n    this.bt = 'bigbutton';\r\n    var txtSize = 14;\r\n    var h = 28;\r\n    if(bigger){\r\n        this.bt = 'biggerbutton';\r\n        txtSize = 28;\r\n        h = 46;\r\n        sideWidth = 31;\r\n    }\r\n\r\n    this.slices.push(_UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scene.add.sprite(x-sideWidth,y,'UI',this.bt+'_left'));\r\n    this.slices.push(_UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scene.add.tileSprite(x,y,4,h,'UI',this.bt+'_middle'));\r\n    this.slices.push(_UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scene.add.sprite(x+sideWidth,y,'UI',this.bt+'_right'));\r\n    this.text = _UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scene.add.text(x, y, '', { font: txtSize+'px belwe', fill: '#ffffff', stroke: '#000000', strokeThickness: 3 });\r\n    this.text.setOrigin(0.5);\r\n\r\n    this.callback = callback;\r\n    this.text.handleDown = this.handleDown.bind(this);\r\n    this.text.handleClick = this.handleClick.bind(this);\r\n    this.enabled = true;\r\n    this.setText(text);\r\n\r\n    this.slices.forEach(function(e){\r\n        e.setDepth(1);\r\n        e.setScrollFactor(0);\r\n        e.setVisible(false);\r\n        this.attachCallbacks(e);\r\n    },this);\r\n\r\n    this.text.setDepth(2);\r\n    this.text.setScrollFactor(0);\r\n    this.text.setVisible(false);\r\n    this.attachCallbacks(this.text);\r\n\r\n    this.lastClick = 0;\r\n    this.enabled = true;\r\n}\r\n\r\nBigButton.prototype.attachCallbacks = function(element){\r\n    element.setInteractive();\r\n    element.on('pointerdown',this.handleDown.bind(this));\r\n    element.on('pointerup',this.handleClick.bind(this));\r\n    element.on('pointerover',this.handleOver.bind(this));\r\n    element.on('pointerout',this.handleOut.bind(this));\r\n};\r\n\r\nBigButton.prototype.setText = function(text){\r\n    this.text.setText(text);\r\n\r\n    var left = this.slices[0];\r\n    var body = this.slices[1];\r\n    var right = this.slices[2];\r\n\r\n    var currentw = body.width;\r\n    var neww = this.text.width - 45;\r\n    var dw = neww - currentw;\r\n\r\n    body.width = neww;\r\n    left.x -= dw/2;\r\n    right.x += dw/2;\r\n\r\n    body.setInteractive();\r\n    body.refWidth = body.width;\r\n    body.refHeight = body.height;\r\n};\r\n\r\nBigButton.prototype.handleDown = function(){\r\n    if(!this.enabled) return;\r\n    _UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scene.sound.add('click').play();\r\n    this.slices[0].setFrame(this.bt+'_left_pressed');\r\n    this.slices[1].setFrame(this.bt+'_middle_pressed');\r\n    this.slices[2].setFrame(this.bt+'_right_pressed');\r\n    this.resetSize();\r\n};\r\n\r\nBigButton.prototype.handleClick = function(){\r\n    if(!this.enabled) return;\r\n    if(Date.now() - this.lastClick > 500){\r\n        this.callback();\r\n        this.lastClick = Date.now();\r\n    }\r\n    this.handleOver();\r\n};\r\n\r\nBigButton.prototype.handleOver = function(){\r\n    if(!this.enabled) return;\r\n    this.slices[0].setFrame(this.bt+'_left_lit');\r\n    this.slices[1].setFrame(this.bt+'_middle_lit');\r\n    this.slices[2].setFrame(this.bt+'_right_lit');\r\n    this.resetSize();\r\n};\r\n\r\nBigButton.prototype.handleOut = function(){\r\n    if(!this.enabled) return;\r\n    this.slices[0].setFrame(this.bt+'_left');\r\n    this.slices[1].setFrame(this.bt+'_middle');\r\n    this.slices[2].setFrame(this.bt+'_right');\r\n    this.resetSize();\r\n};\r\n\r\n\r\nBigButton.prototype.enable = function(){\r\n    this.slices[0].setFrame(this.bt+'_left');\r\n    this.slices[1].setFrame(this.bt+'_middle');\r\n    this.slices[2].setFrame(this.bt+'_right');\r\n    this.resetSize();\r\n    this.enabled = true;\r\n};\r\n\r\nBigButton.prototype.disable = function(){\r\n    this.slices[0].setFrame(this.bt+'_left_gray');\r\n    this.slices[1].setFrame(this.bt+'_middle_gray');\r\n    this.slices[2].setFrame(this.bt+'_right_gray');\r\n    this.resetSize();\r\n    this.enabled = false;\r\n};\r\n\r\nBigButton.prototype.resetSize = function(){\r\n    var body = this.slices[1];\r\n    body.setSize(body.refWidth,body.refHeight);\r\n};\r\n\r\nBigButton.prototype.display = function(){\r\n    this.slices.forEach(function(e){\r\n        e.setVisible(true);\r\n    });\r\n    this.text.setVisible(true);\r\n};\r\n\r\nBigButton.prototype.hide = function(){\r\n    this.slices.forEach(function(e){\r\n        e.setVisible(false);\r\n    });\r\n    this.text.setVisible(false);\r\n};\r\n\r\nBigButton.prototype.moveUp = function(nb){\r\n    this.slices.forEach(function(e){\r\n        e.setDepth(e.depth+nb);\r\n    });\r\n    this.text.setDepth(this.text.depth+nb);\r\n};\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (BigButton);\n\n//# sourceURL=webpack:///./client/BigButton.js?");

/***/ }),

/***/ "./client/Boot.js":
/*!************************!*\
  !*** ./client/Boot.js ***!
  \************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _BigButton__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./BigButton */ \"./client/BigButton.js\");\n/* harmony import */ var _Client__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Client */ \"./client/Client.js\");\n/* harmony import */ var _UI__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./UI */ \"./client/UI.js\");\n/**\r\n * Created by Jerome on 15-09-17.\r\n */\r\n\r\n\r\n\r\n\r\nvar Boot = new Phaser.Class({\r\n\r\n    Extends: Phaser.Scene,\r\n    initialize: function Boot() {\r\n        Phaser.Scene.call(this, { key: 'boot',plugins: ['Clock','DataManagerPlugin','InputPlugin','Loader','TweenManager','LightsPlugin']});\r\n        this.readyTicks = 0;\r\n    },\r\n\r\n    preload: function(){\r\n        Boot.mapDataLocation = '/maps';\r\n        Boot.masterKey = 'master';\r\n        this.load.json(Boot.masterKey,Boot.mapDataLocation+'/master.json');\r\n\r\n        this.load.image('background', 'assets/sprites/background.png');\r\n        this.load.atlas('logo', 'assets/sprites/logo.png', 'assets/sprites/logo.json');\r\n    },\r\n\r\n    create: function(){\r\n        _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].getBootParameters();\r\n\r\n        var masterData = this.cache.json.get(Boot.masterKey);\r\n        //Boot.tilesets = masterData.tilesets;\r\n        Boot.masterData = masterData;\r\n\r\n        Boot.background = this.add.image(0,0,'background').setOrigin(0);\r\n\r\n        this.readyStages = {\r\n            1: this.launchUI, // 1 for getting boot parameters\r\n            2: this.displayButton // 2 for UI scene creation\r\n        };\r\n        this.displayTitle();\r\n\r\n        Boot.WEBGL = true;\r\n\r\n        var gl;\r\n        try { gl = game.canvas.getContext(\"webgl\"); }\r\n        catch (x) { gl = null; }\r\n\r\n        if(!gl){\r\n            Boot.WEBGL = false;\r\n            console.warn('WEBGL not supported');\r\n            document.getElementById(\"danger\").innerText = \"Your browser does not support WebGL. Some visual effects will be disabled or may render poorly.\";\r\n        }\r\n\r\n        if(detectBrowser() != \"Chrome\") document.getElementById(\"browser\").innerText = \"This development version is best played using Chrome. With other browsers, lag and rendering issues may arise.\";\r\n    },\r\n\r\n    updateReadyTick: function() {\r\n        this.readyTicks++;\r\n        if(this.readyTicks in this.readyStages) this.readyStages[this.readyTicks].call(this);\r\n    },\r\n\r\n    launchUI: function(){\r\n        this.scene.launch('UI');\r\n    },\r\n\r\n    displayTitle: function(){\r\n        Boot.titleBg = this.add.image(512,218,'logo','bg').setAlpha(0).setScale(0.5);\r\n        Boot.title = this.add.image(512,218,'logo','text').setAlpha(0).setScale(0.5);\r\n\r\n        this.tweens.add({\r\n            targets: Boot.titleBg,\r\n            alpha: 1,\r\n            duration: 1000\r\n        });\r\n\r\n        this.tweens.add({\r\n            targets: Boot.title,\r\n            alpha: 1,\r\n            duration: 1500,\r\n            delay: 750,\r\n            onComplete: this.updateReadyTick.bind(this)\r\n        });\r\n    },\r\n\r\n    displayButton: function(){\r\n        Boot.buttons = [];\r\n        Boot.buttons.push(new _BigButton__WEBPACK_IMPORTED_MODULE_0__[\"default\"](512,400,'Play',_UI__WEBPACK_IMPORTED_MODULE_2__[\"default\"].launchGameMode,true)); // true = bigger\r\n\r\n        if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].gameConfig.boot.offerTutorial) Boot.buttons.push(new _BigButton__WEBPACK_IMPORTED_MODULE_0__[\"default\"](512, 450, 'Tutorial', _UI__WEBPACK_IMPORTED_MODULE_2__[\"default\"].launchTutorialMode,true));\r\n\r\n        Boot.buttons.forEach(function(b){\r\n            b.display();\r\n        })\r\n    }\r\n});\r\n\r\nBoot.bootParamsReceived = function(){\r\n    this.readyTicks++;\r\n};\r\n\r\n\r\nfunction detectBrowser(){\r\n    // Opera 8.0+\r\n    var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;\r\n    if(isOpera) return 'Opera';\r\n\r\n    // Firefox 1.0+\r\n    var isFirefox = typeof InstallTrigger !== 'undefined';\r\n    if(isFirefox) return 'Firefox';\r\n\r\n    // Safari 3.0+ \"[object HTMLElementConstructor]\"\r\n    var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === \"[object SafariRemoteNotification]\"; })(!window['safari'] || safari.pushNotification);\r\n    if(isSafari) return 'Safari';\r\n\r\n    // Internet Explorer 6-11\r\n    var isIE = /*@cc_on!@*/ false || !!document.documentMode;\r\n    if(isIE) return 'IE';\r\n\r\n    // Edge 20+\r\n    var isEdge = !isIE && !!window.StyleMedia;\r\n    if(isEdge) return 'Edge';\r\n\r\n    // Chrome 1+\r\n    var isChrome = !!window.chrome;\r\n    if(isChrome) return 'Chrome';\r\n\r\n    // Blink engine detection\r\n    var isBlink = (isChrome || isOpera) && !!window.CSS;\r\n    if(isBlink) return 'Blink';\r\n\r\n    return 'unknown';\r\n}\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (Boot);\r\n\n\n//# sourceURL=webpack:///./client/Boot.js?");

/***/ }),

/***/ "./client/Client.js":
/*!**************************!*\
  !*** ./client/Client.js ***!
  \**************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _Boot__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Boot */ \"./client/Boot.js\");\n/**\r\n * Created by Jerome on 30-06-17.\r\n */\r\n\r\n\r\n\r\nvar Client = {\r\n    initEventName: 'init', // name of the event that triggers the call to initWorld() and the initialization of the game\r\n    storageIDKey: 'playerID', // key in localStorage of player ID\r\n    eventsQueue : [] // when events arrive before the flag playerIsInitialized is set to true, they are not processed\r\n};\r\n\r\nClient.socket = io.connect();\r\n\r\nClient.emptyQueue = function(){ // Process the events that have been queued during initialization\r\n    for(var e = 0; e < Client.eventsQueue.length; e++){\r\n        Client.socket.onevent.call(Client.socket,Client.eventsQueue[e]);\r\n    }\r\n};\r\n\r\nClient.requestData = function(){ // request the data to be used for initWorld()\r\n    console.log('requesting data');\r\n    Client.socket.emit('init-world',Client.getInitRequest());\r\n\r\n    // The following checks if the game is initialized or not, and based on this either queues the events or process them\r\n    // The original socket.onevent function is copied to onevent. That way, onevent can be used to call the origianl function,\r\n    // whereas socket.onevent can be modified for our purpose!\r\n    var onevent = Client.socket.onevent;\r\n    Client.socket.onevent = function (packet) {\r\n        if(!Engine.playerIsInitialized && packet.data[0] != Client.initEventName && packet.data[0] != 'dbError'){\r\n            console.warn('queueing ',packet.data[0]);\r\n            Client.eventsQueue.push(packet);\r\n        }else{\r\n            onevent.call(this, packet);    // original call\r\n        }\r\n    };\r\n};\r\n\r\nClient.getInitRequest = function(){ // Returns the data object to send to request the initialization data\r\n    // In case of a new player, set new to true and send the name of the player\r\n    // Else, set new to false and send it's id instead to fetch the corresponding data in the database\r\n    if(Client.tutorial){\r\n        return {\r\n            new: true,\r\n            tutorial:true\r\n        };\r\n    }\r\n    if(Client.isNewPlayer()) {\r\n        console.log('Requesting data for new player');\r\n        return {\r\n            new:true,\r\n            tutorial: false,\r\n            selectedClass: UI.selectedClass,\r\n            selectedSettlement: UI.selectedSettlement,\r\n            characterName: UI.characterName\r\n        };\r\n    }\r\n    return {\r\n        new:false,\r\n        id:Client.getPlayerID(),\r\n        stamp: Client.getIDStamp()\r\n    };\r\n};\r\n\r\nClient.getIDStamp = function(){\r\n    return localStorage.getItem('idStamp');\r\n};\r\n\r\nClient.getBootParameters = function(){\r\n    Client.socket.emit('boot-params',{id:Client.getPlayerID()});\r\n};\r\n\r\nClient.checkForNewPlayer = function(){\r\n    console.log('Player id:',Client.getPlayerID());\r\n    //Client.newPlayer = (Client.getPlayerID() === null);\r\n};\r\n\r\nClient.isNewPlayer = function(){\r\n    if(Client.gameConfig) {\r\n        if(Client.gameConfig.boot.forceNewPlayer) return true;\r\n        return Client.newPlayer;\r\n    }\r\n    console.error('Missing Client.gameConfig');\r\n};\r\n\r\nClient.getPlayerID = function(){\r\n    return localStorage.getItem(Client.storageIDKey);\r\n};\r\n\r\nClient.isFirstBattle = function(){\r\n    return !localStorage.getItem('firstBattle');\r\n};\r\n\r\nClient.hadFirstBattle = function(){\r\n    localStorage.setItem('firstBattle',true);\r\n};\r\n\r\n// #### RECEIVERS ####\r\n\r\nClient.socket.on(Client.initEventName,function(data){ // This event triggers when receiving the initialization packet from the server, to use in Game.initWorld()\r\n    console.log('Init packet received');\r\n    //if(data instanceof ArrayBuffer) data = Decoder.decode(data,CoDec.initializationSchema); // if in binary format, decode first\r\n    // Client.socket.emit('ponq',data.stamp); // send back a pong stamp to compute latency\r\n    Client.serverTimeDelta = data.refTime - Date.now();\r\n    Engine.initWorld(data.player);\r\n    //Game.updateNbConnected(data.nbconnected);\r\n    console.log(Client.serverTimeDelta,'time delta');\r\n});\r\n\r\nClient.socket.on('wait',function(){\r\n    // wait is sent back from the server when the client attempts to connect before the server is done initializing and reading the map\r\n    console.log('Server not ready, re-attempting...');\r\n    setTimeout(Client.requestData, 500); // Just try again in 500ms\r\n});\r\n\r\nClient.socket.on('region-data',function(data){\r\n    UI.displayRegions(data);\r\n});\r\n\r\nClient.socket.on('camps-data',function(data){\r\n    UI.displayCamps(data);\r\n});\r\n\r\nClient.socket.on('boot-params',function(data){\r\n    Client.gameConfig = data;\r\n    console.log(Client.gameConfig);\r\n    _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].bootParamsReceived();\r\n    Client.newPlayer = data.newPlayer;\r\n    Client.nbConnected = data.nbc;\r\n    console.log(Client.nbConnected+' connected');\r\n});\r\n\r\nClient.socket.on('update',function(data){ // This event triggers uppon receiving an update packet (data)\r\n    //if(data instanceof ArrayBuffer) data = Decoder.decode(data,CoDec.finalUpdateSchema); // if in binary format, decode first\r\n    //Client.socket.emit('ponq',data.stamp);  // send back a pong stamp to compute latency\r\n    //if(data.nbconnected !== undefined) Game.updateNbConnected(data.nbconnected);\r\n    //if(data.latency) Game.setLatency(data.latency);\r\n    //if(data.latency) console.log('[lat] '+data.latency+' ms');\r\n    if(data.local) console.log(data.local);\r\n    if(data.global) console.log(data.global);\r\n    if(data.local) Engine.updateSelf(data.local); // Should come first\r\n    if(data.global) Engine.updateWorld(data.global);\r\n    if(data.qt) Engine.debugQT(data.qt);\r\n    Engine.currentTurn = data.turn;\r\n});\r\n\r\nClient.socket.on('pid',function(playerID){ // the 'pid' event is used for the server to tell the client what is the ID of the player\r\n    Client.setLocalData(playerID);\r\n});\r\n\r\nClient.setLocalData = function(id){ // store the player ID in localStorage\r\n    //console.log('your ID : '+id);\r\n    localStorage.setItem(Client.storageIDKey,id);\r\n    localStorage.setItem('idStamp',Date.now());\r\n};\r\n\r\n/// ##### SENDERS ######\r\n\r\nClient.requestRegionsData = function(){\r\n    Client.socket.emit('region-data');\r\n};\r\n\r\nClient.requestCampsData = function(){\r\n    Client.socket.emit('camps-data');\r\n};\r\n\r\nClient.sendPath = function(path,action){\r\n    Client.socket.emit('path',{path:path,action:action});\r\n};\r\n\r\nClient.buildingClick = function(targetID){\r\n    Client.socket.emit('buildingClick',{id:targetID});\r\n};\r\n\r\nClient.NPCClick = function(targetID,type){\r\n    Client.socket.emit('NPCClick',{id:targetID,type:type});\r\n};\r\n\r\nClient.battleAction = function(action,data){\r\n    data.action = action;\r\n    Client.socket.emit('battleAction',data);\r\n};\r\n\r\nClient.sendCraft = function(id,nb,stock){\r\n    Client.socket.emit('craft',{id:id,nb:nb,stock:stock});\r\n};\r\n\r\nClient.sendPurchase = function(id,nb, action, financial){\r\n    Client.socket.emit('shop',{id:id,nb:nb,action:action,financial:financial});\r\n};\r\n\r\nClient.sendStock  = function(item,nb,building,action){\r\n    Client.socket.emit('stock',{item:item,nb:nb,building:building,action:action});\r\n};\r\n\r\nClient.sendUse = function(id, inventory){\r\n    Client.socket.emit('use',{item:id, inventory:inventory});\r\n};\r\n\r\nClient.sendBelt = function(id, inventory){\r\n    Client.socket.emit('belt',{item:id, inventory:inventory});\r\n};\r\n\r\n\r\nClient.sendUnequip = function(slot,subslot){\r\n    Client.socket.emit('unequip',{slot:slot,subslot:subslot});\r\n};\r\n\r\nClient.sendExit = function(){\r\n    Client.socket.emit('exit');\r\n};\r\n\r\nClient.sendBuild = function(id,tile){\r\n    Client.socket.emit('build',{id:id,tile:tile});\r\n};\r\n\r\nClient.setPrices = function(id,buy,sell){\r\n    Client.socket.emit('prices',{item:id,buy:buy,sell:sell});\r\n};\r\n\r\nClient.exchangeGold = function(nb){\r\n    Client.socket.emit('gold',{nb:nb});\r\n};\r\n\r\nClient.sendChat = function(text){\r\n    Client.socket.emit('chat',text);\r\n};\r\n\r\nClient.sendRespawn = function(){\r\n    Client.socket.emit('respawn');\r\n};\r\n\r\nClient.logMenu = function(menu){\r\n    Client.socket.emit('menu',menu);\r\n};\r\n\r\nClient.sendTutorialStart = function(){\r\n    Client.socket.emit('tutorial-start');\r\n};\r\n\r\nClient.sendTutorialStep = function(step){\r\n    Client.socket.emit('tutorial-step',step);\r\n};\r\n\r\nClient.sendTutorialEnd = function(){\r\n    Client.socket.emit('tutorial-end');\r\n};\r\n// ####################\"\r\n\r\nClient.sendMapData = function(id,data){\r\n    Client.socket.emit('mapdata',{id:id,data:data});\r\n};\r\n\r\nClient.sendScreenshot = function(image,browser){\r\n    Client.socket.emit('screenshot',{img:image,browser:browser});\r\n};\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (Client);\n\n//# sourceURL=webpack:///./client/Client.js?");

/***/ }),

/***/ "./client/CustomSprite.js":
/*!********************************!*\
  !*** ./client/CustomSprite.js ***!
  \********************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/**\r\n * Created by Jerome on 07-10-17.\r\n */\r\n\r\nvar CustomSprite = new Phaser.Class({\r\n\r\n    Extends: Phaser.GameObjects.Sprite,\r\n\r\n    initialize: function CustomSprite (scene, x, y, texture) {\r\n        Phaser.GameObjects.Sprite.call(this, scene, x, y, texture);\r\n        scene.add.displayList.add(this);\r\n        scene.add.updateList.add(this);\r\n    },\r\n\r\n    remove: function(){\r\n        this.setVisible(false);\r\n        Engine.entityManager.removeFromDisplayList(this);\r\n        Engine.entityManager.addToPool(this);\r\n    },\r\n\r\n    // ### SETTERS ###\r\n\r\n    setID: function(id){\r\n        this.id = id;\r\n    },\r\n\r\n    setTilePosition: function(x,y,setPixelPosition){\r\n        this.tileX = x;\r\n        this.tileY = y;\r\n        this.chunk = Utils.tileToAOI({x: this.tileX, y: this.tileY});\r\n        if(this.postChunkUpdate) this.postChunkUpdate();\r\n        if(setPixelPosition) this.setPosition(this.tileX * Engine.tileWidth, this.tileY * Engine.tileHeight);\r\n        if(isNaN(this.tileX) || isNaN(this.tileY) || isNaN(this.x) || isNaN(this.y)) console.warn('Warning: NaN coordinates for ',this.entityType,this.id);\r\n    },\r\n\r\n    highlight: function(){\r\n        this.setPipeline('highlight');\r\n        var texture = this.texture.source[0];\r\n        // this.pipeline.setFloat1('uRadius', 2.0);\r\n        this.pipeline.setFloat4('uFrameCut', this.frame.data.cut.x,this.frame.data.cut.y,this.frame.data.cut.w,this.frame.data.cut.h);\r\n        this.pipeline.setFloat2('uTextureSize', texture.width,texture.height);\r\n    },\r\n\r\n    hollow: function(){\r\n        if(this.hollowed) return;\r\n        this.hollowed = true;\r\n        this.setDepth(this.tileY + 5);\r\n        this.setPipeline('hollow_'+(this.entityType == 'item' ? 'items' : 'moving'));\r\n        var texture = this.texture.source[0];\r\n        this.pipeline.setFloat4('uFrameCut', this.frame.data.cut.x,this.frame.data.cut.y,this.frame.data.cut.w,this.frame.data.cut.h);\r\n        this.pipeline.setFloat2('uTextureSize', texture.width,texture.height);\r\n    },\r\n\r\n    unhollow: function(){\r\n        this.hollowed = false;\r\n        this.resetPipeline();\r\n        this.updateDepth();\r\n    },\r\n});\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (CustomSprite);\n\n//# sourceURL=webpack:///./client/CustomSprite.js?");

/***/ }),

/***/ "./client/Engine.js":
/*!**************************!*\
  !*** ./client/Engine.js ***!
  \**************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _Boot__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Boot */ \"./client/Boot.js\");\n/* harmony import */ var _Client__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Client */ \"./client/Client.js\");\n/* harmony import */ var _menuIcon__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./menuIcon */ \"./client/menuIcon.js\");\n/* harmony import */ var _shared_SpaceMap__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../shared/SpaceMap */ \"./shared/SpaceMap.js\");\n/* harmony import */ var _shared_World__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../shared/World */ \"./shared/World.js\");\n/**\r\n * Created by Jerome on 26-06-17.\r\n */\r\n\r\n\r\n\r\n\r\n\r\n\r\nvar Engine = {\r\n    // TODO: Move to conf?\r\n    tileWidth: 32,\r\n    tileHeight: 32,\r\n\r\n    markerDepth: 1,\r\n    buildingsDepth: 2,\r\n    playersDepth: 2,\r\n    bubbleDepth: 11,\r\n\r\n    UIDepth: 12,\r\n    UIElementsDepth: 13,\r\n    UIContentDepth: 14,\r\n    UITextDepth: 15,\r\n\r\n    tooltipDepth: 16,\r\n    tooltipElementsDepth: 17,\r\n    tooltipTextDepth: 18,\r\n\r\n    // TODO: Move to conf\r\n    maxPathLength: 36,\r\n\r\n    debugMarker: true,\r\n    debugCollisions: false,\r\n    dummyUI: false,\r\n\r\n    key: 'game', // key of the scene, for Phaser\r\n    plugins: ['Clock','DataManagerPlugin','InputPlugin','Loader','TweenManager'], // 'LightsPlugin'\r\n    playerIsInitialized: false\r\n};\r\n\r\nvar tilesetData = {};\r\n\r\nEngine.preload = function() {\r\n    Engine.useTilemaps = false;\r\n\r\n    this.load.atlas('tileset', 'assets/tilesets/tileset.png', 'assets/tilesets/tileset.json');\r\n\r\n    // Characters\r\n    this.load.spritesheet('enemy', 'assets/sprites/enemy.png',{frameWidth:64,frameHeight:64});\r\n    this.load.spritesheet('hero', 'assets/sprites/newhero.png',{frameWidth:64,frameHeight:64}); // http://gaurav.munjal.us/Universal-LPC-Spritesheet-Character-Generator/#\r\n\r\n\r\n    this.load.spritesheet('graywolf', 'assets/sprites/animals/graywolf.png',{frameWidth:43,frameHeight:32});\r\n    this.load.spritesheet('blackwolf', 'assets/sprites/animals/blackwolf.png',{frameWidth:43,frameHeight:32});\r\n    this.load.spritesheet('whitewolf', 'assets/sprites/animals/whitewolf.png',{frameWidth:43,frameHeight:32});\r\n    this.load.spritesheet('bears', 'assets/sprites/animals/bears.png',{frameWidth:56,frameHeight:56});\r\n    this.load.spritesheet('butterfly', 'assets/sprites/animals/butterfly.png',{frameWidth:9,frameHeight:7});\r\n\r\n    this.load.spritesheet('bones', 'assets/sprites/wolf_bones.png',{frameWidth:32,frameHeight:21});\r\n\r\n    // ###################\r\n\r\n    // Misc\r\n    this.load.spritesheet('3grid', 'assets/sprites/3grid.png',{frameWidth:32,frameHeight:32});\r\n    this.load.spritesheet('bubble', 'assets/sprites/bubble2.png',{frameWidth:5,frameHeight:5});\r\n    this.load.spritesheet('faces', 'assets/sprites/faces.png',{frameWidth:32,frameHeight:32});\r\n    this.load.spritesheet('footsteps', 'assets/sprites/footstepssheet.png',{frameWidth:16,frameHeight:16});\r\n    this.load.spritesheet('marker', 'assets/sprites/marker.png',{frameWidth:32,frameHeight:32});\r\n\r\n    // Animations\r\n    this.load.spritesheet('sword_anim', 'assets/sprites/Sword1.png',{frameWidth:96,frameHeight:96});\r\n    this.load.spritesheet('explosion', 'assets/sprites/explosion.png',{frameWidth:100,frameHeight:100});\r\n\r\n    // Buildings\r\n    this.load.atlas('buildings_sprites', 'assets/sprites/buildings.png', 'assets/sprites/buildings.json');\r\n\r\n    // Icons\r\n    this.load.atlas('mapicons', 'assets/sprites/mapicons.png', 'assets/sprites/mapicons.json');\r\n    this.load.atlas('battleicons', 'assets/sprites/battleicons.png', 'assets/sprites/battleicons.json');\r\n    // this.load.atlas('trayicons', 'assets/sprites/trayicons.png', 'assets/sprites/trayicons.json');\r\n    this.load.atlas('buildingsicons', 'assets/sprites/buildingsicons.png', 'assets/sprites/buildingsicons.json');\r\n\r\n    this.load.atlas('items', 'assets/sprites/items.png', 'assets/sprites/items.json');\r\n    this.load.atlas('items2', 'assets/sprites/resources_full.png', 'assets/sprites/resources_full.json');\r\n    this.load.atlas('items_gr', 'assets/sprites/items_gr.png', 'assets/sprites/items.json');\r\n    this.load.atlas('items2_gr', 'assets/sprites/resources_full_gr.png', 'assets/sprites/resources_full.json');\r\n\r\n    // Misc\r\n    this.load.image('bug', 'assets/sprites/bug.png');\r\n    this.load.atlas('orientation', 'assets/sprites/orientation.png', 'assets/sprites/orientation.json');\r\n    this.load.image('tail', 'assets/sprites/tail.png');\r\n    this.load.image('scrollbgh', 'assets/sprites/scroll.png');\r\n    this.load.image('bigbg', 'assets/sprites/bigbg.png');\r\n    this.load.image('bigbg_mask', 'assets/sprites/bigbg_mask.png');\r\n    // this.load.image('longscroll', 'assets/sprites/longscroll.png');\r\n    // this.load.image('radiallongrect', 'assets/sprites/radial_longrect.png');\r\n    this.load.image('worldmap', 'maps/worldmap.png');\r\n\r\n    // SFX\r\n    Engine.audioFiles = [];\r\n    this.load.audio('arrow','assets/sfx/arrow.wav');\r\n    this.load.audio('arrow_miss','assets/sfx/arrow_miss.wav');\r\n    this.load.audio('bomb','assets/sfx/bomb.wav');\r\n    this.load.audio('footsteps','assets/sfx/footsteps.wav');\r\n    this.load.audio('sellbuy','assets/sfx/sell_buy_item.wav');\r\n    this.load.audio('speech','assets/sfx/speech.ogg');\r\n    this.load.audio('inventory','assets/sfx/leather_inventory.wav');\r\n    this.load.audio('crafting','assets/sfx/metal-clash.wav');\r\n    this.load.audio('page_turn','assets/sfx/turn_page.wav');\r\n    this.load.audio('page_turn2','assets/sfx/turn_page2.wav');\r\n    this.load.audio('page_turn3','assets/sfx/turn_page3.wav');\r\n    this.load.audio('book','assets/sfx/book.wav');\r\n    this.load.audio('equip','assets/sfx/chainmail1.wav');\r\n    this.load.audio('cloth','assets/sfx/cloth.wav');\r\n    this.load.audio('woodsmall','assets/sfx/wood-small.wav');\r\n    this.load.audio('alchemy','assets/sfx/alchemy.wav');\r\n    this.load.audio('birds1','assets/sfx/birds1.wav');\r\n    this.load.audio('birds2','assets/sfx/birds2.wav');\r\n    this.load.audio('birds3','assets/sfx/birds3.wav');\r\n    this.load.audio('bird','assets/sfx/bird.wav');\r\n    this.load.audio('cricket','assets/sfx/cricket.wav');\r\n    this.load.audio('raven','assets/sfx/raven.wav');\r\n    this.load.audio('bubbles','assets/sfx/bubbles.wav');\r\n    this.load.audio('powder','assets/sfx/powder.wav');\r\n    this.load.audio('clank','assets/sfx/clank.wav');\r\n    this.load.audio('sword','assets/sfx/sword.wav');\r\n    this.load.audio('soft','assets/sfx/soft.ogg');\r\n    this.load.audio('hit','assets/sfx/hit.wav');\r\n    this.load.audio('wolfambient','assets/sfx/wolfambient1.wav');\r\n    this.load.audio('wolfattack1','assets/sfx/wolfattack1.wav');\r\n    this.load.audio('wind1','assets/sfx/wind1.wav');\r\n    this.load.audio('wind2','assets/sfx/wind2.wav');\r\n    this.load.audio('wind3','assets/sfx/wind3.wav');\r\n\r\n    this.load.json('buildings', 'assets/data/buildings.json');\r\n    this.load.json('itemsData', 'assets/data/items.json');\r\n    this.load.json('animals', 'assets/data/animals.json');\r\n    this.load.json('civs', 'assets/data/civs.json');\r\n\r\n\r\n    if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) this.load.json('tutorials', 'assets/data/tutorials.json');\r\n};\r\n\r\nEngine.entityManager = {\r\n    entities: [],\r\n    constructors: {},\r\n    maps: {},\r\n    pools: {},\r\n    displayLists: {},\r\n\r\n    registerEntityType: function(key,constructor,map){\r\n        Engine.entityManager.entities.push(key);\r\n        Engine.entityManager.constructors[key] = constructor;\r\n        Engine.entityManager.maps[key] = map;\r\n        Engine.entityManager.pools[key] = [];\r\n        Engine.entityManager.displayLists[key] = new Set();\r\n    },\r\n\r\n    addToDisplayList: function(entity){\r\n        Engine.entityManager.displayLists[entity.entityType].add(entity.id);\r\n    },\r\n\r\n    addToPool: function(entity){\r\n        Engine.entityManager.pools[entity.entityType].push(entity);\r\n    },\r\n\r\n    removeFromDisplayList: function(entity){\r\n        Engine.entityManager.displayLists[entity.entityType].delete(entity.id);\r\n    }\r\n};\r\n\r\nfunction Pool(type,texture,constructor){\r\n    this.type = type;\r\n    this.texture = texture;\r\n    this.constructor = constructor;\r\n    this.reserve = [];\r\n}\r\n\r\nPool.prototype.getNext = function(){\r\n    if(this.reserve.length > 0) return this.reserve.shift();\r\n    //console.log('creating new element');\r\n    var element;\r\n    switch(this.type){\r\n        case 'sprite':\r\n            element = Engine.scene.add.sprite(0,0,this.texture);\r\n            break;\r\n        case 'image':\r\n            element = Engine.scene.add.image(0,0,this.texture);\r\n            break;\r\n        case 'text':\r\n            element = Engine.scene.add.text(0,0, '');\r\n            break;\r\n        case 'custom':\r\n            return new this.constructor();\r\n        default:\r\n            console.warn('no type defined');\r\n            break;\r\n    }\r\n    var _pool = this;\r\n    element.recycle = function(){\r\n        this.setVisible(false);\r\n        _pool.recycle(this);\r\n    };\r\n    return element;\r\n};\r\n\r\nPool.prototype.recycle = function(element){\r\n    //console.warn('recycling element');\r\n    this.reserve.push(element);\r\n};\r\n\r\nEngine.create = function(){\r\n    Engine.scene = this.scene.scene;\r\n\r\n    var masterData = _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].masterData;\r\n    _shared_World__WEBPACK_IMPORTED_MODULE_4__[\"default\"].readMasterData(masterData);\r\n    Engine.mapDataLocation = _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].mapDataLocation;\r\n\r\n    tilesetData.atlas = Engine.scene.cache.json.get('tileset').frames;\r\n    tilesetData.config = Engine.scene.cache.json.get('tileset').config;\r\n    tilesetData.shorthands = Engine.scene.cache.json.get('tileset').shorthands;\r\n\r\n    Engine.chunks = {}; // holds references to the containers containing the chunks\r\n    Engine.displayedChunks = [];\r\n    Engine.mapDataCache = {};\r\n\r\n    var animations = ['explosion','sword'];\r\n    Engine.animationsPools = {};\r\n    animations.forEach(function(key){\r\n        Engine.animationsPools[key] = new Pool('sprite',key);\r\n    });\r\n    Engine.footprintsPool = new Pool('image','footsteps');\r\n\r\n    Engine.imagePool = new Pool('image','items');\r\n    Engine.imagePool2 = new Pool('image','items2');\r\n    // TODO why? - why not imageItemPool, imageItemPool2\r\n\r\n    Engine.arrowsPool = new Pool('image','items');\r\n    Engine.bombsPool = new Pool('image','items2');\r\n    Engine.textPool = new Pool('text');\r\n\r\n    Engine.players = {}; // player.id -> player object\r\n    Engine.animals = {}; // animal.id -> building object\r\n    Engine.buildings = {}; // building.id -> building object\r\n    Engine.items = {};\r\n    Engine.remains = {};\r\n    Engine.civs = {};\r\n    Engine.battleCells = {}; // cell.id -> cell object\r\n    Engine.battleCellsMap = new _shared_SpaceMap__WEBPACK_IMPORTED_MODULE_3__[\"SpaceMap\"]();\r\n    Engine.entityManager.registerEntityType('player',Player,Engine.players);\r\n    Engine.entityManager.registerEntityType('animal',Animal,Engine.animals);\r\n    Engine.entityManager.registerEntityType('building',Building,Engine.buildings);\r\n    Engine.entityManager.registerEntityType('item',Item,Engine.items);\r\n    Engine.entityManager.registerEntityType('cell',BattleTile,Engine.battleCells);\r\n    Engine.entityManager.registerEntityType('civ',Civ,Engine.civs);\r\n    Engine.entityManager.registerEntityType('remain',Remains,Engine.remains);\r\n\r\n\r\n\r\n    Engine.debug = true;\r\n    Engine.showHero = true;\r\n    Engine.showGrid = false;\r\n    Engine.qtQuads = []; // for debugging\r\n\r\n    Engine.camera = Engine.scene.cameras.main;\r\n    Engine.camera.setBounds(0,0,Engine.worldWidth*TILE_WIDTH,Engine.worldHeight*TILE_HEIGHT);\r\n\r\n    Engine.buildingsData = Engine.scene.cache.json.get('buildings');\r\n    Engine.animalsData = Engine.scene.cache.json.get('animals');\r\n    Engine.civsData = Engine.scene.cache.json.get('civs');\r\n    Engine.itemsData = Engine.scene.cache.json.get('itemsData');\r\n\r\n    Engine.createMarker();\r\n    Engine.createAnimations();\r\n\r\n    Engine.dragging = false;\r\n    Engine.interrupt = false;\r\n    Engine.scene.input.setTopOnly(false);\r\n    Engine.scene.input.on('pointerdown', Engine.handleDown);\r\n    Engine.scene.input.on('pointerup', Engine.handleClick);\r\n    Engine.scene.input.on('pointermove', Engine.trackMouse);\r\n\r\n    // TODO: move these to classes\r\n    Engine.scene.input.setPollAlways();\r\n    Engine.scene.input.on('pointerover', Engine.handleOver);\r\n    Engine.scene.input.on('pointerout', Engine.handleOut);\r\n    Engine.scene.input.on('drag', Engine.handleDrag);\r\n    Engine.scene.input.keyboard.on('keydown', Engine.handleKeyboard);\r\n\r\n    Engine.collisions = new _shared_SpaceMap__WEBPACK_IMPORTED_MODULE_3__[\"SpaceMap\"]();\r\n    Engine.overlay = new _shared_SpaceMap__WEBPACK_IMPORTED_MODULE_3__[\"SpaceMap\"]();\r\n    Engine.pathFinder = new Pathfinder(Engine.collisions,Engine.maxPathLength);\r\n\r\n    Engine.resources = new _shared_SpaceMap__WEBPACK_IMPORTED_MODULE_3__[\"SpaceMap\"]();\r\n\r\n    Engine.inMenu = false;\r\n    Engine.inPanel = false;\r\n    Engine.dead = false;\r\n    Engine.currentMenu = null;\r\n    Engine.currentPanel = null;\r\n\r\n    Engine.useBlitters = false;\r\n    if(Engine.useBlitters){\r\n        /* * Blitters:\r\n    * - 1 for ground tileset, depth 0\r\n    * - 1 for trees tileset, depth 2\r\n    * - 1 for canopies, depth 6*/\r\n        Engine.blitters = [];\r\n        Engine.blitters.push(Engine.scene.add.blitter(0,0,'ground_tiles').setDepth(0));\r\n        Engine.blitters.push(Engine.scene.add.blitter(0,0,'trees').setDepth(2));\r\n        Engine.blitters.push(Engine.scene.add.blitter(0,0,'trees').setDepth(4));\r\n    }\r\n\r\n    game.renderer.addPipeline('highlight', new HighlightPipeline(game));\r\n    game.renderer.addPipeline('hollow_items', new HollowPipeline(game));\r\n    game.renderer.addPipeline('hollow_moving', new HollowPipeline(game));\r\n\r\n    Engine.created = true;\r\n    Engine.configEngine();\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].requestData();\r\n};\r\n\r\nEngine.getGameInstance = function(){\r\n    return Engine.scene.sys.game;\r\n};\r\n\r\n// TODO: rename / remove\r\nEngine.getGameConfig = function(){\r\n    return Engine.getGameInstance().config;\r\n};\r\n\r\nEngine.createMarker = function(){\r\n    Engine.marker = Engine.scene.add.sprite(0,0,'marker',0);\r\n    Engine.marker.alpha = 0.8;\r\n    Engine.marker.depth = Engine.markerDepth;\r\n    Engine.marker.setDisplayOrigin(0,0);\r\n    Engine.marker.previousTile = {x:0,y:0};\r\n    Engine.hideMarker();\r\n};\r\n\r\n// Called at the end of create(), data is received before the Engine scene starts\r\nEngine.configEngine = function(){\r\n    Engine.config = _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].gameConfig.config;\r\n};\r\n\r\nEngine.initWorld = function(data){\r\n    /* data = initialization packet sent by server, contains the data from\r\n    Player.initTrim() used in Hero.setUp()\r\n    */\r\n    //Engine.animalUpdates = new ListMap(); // debug purpose, remove\r\n    Engine.firstSelfUpdate = true;\r\n\r\n    console.log(data);\r\n    //Engine.settlementsData = data.settlements;\r\n    Engine.addHero(data);\r\n    Engine.playerIsInitialized = true;\r\n    Engine.updateEnvironment();\r\n\r\n    Engine.makeUI();\r\n\r\n    // TODO: move\r\n    var settlements = {\r\n        0: {name:'New Beginnng'},\r\n        1: {name:'Hope'}\r\n    };\r\n    Engine.setlCapsule.setText(settlements[Engine.player.settlement].name);\r\n\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].emptyQueue(); // Process the queue of packets from the server that had to wait while the client was initializing\r\n    Engine.showMarker();\r\n    if(Engine.miniMap) Engine.miniMap.display();\r\n\r\n    if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].isNewPlayer() && !_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) {\r\n        var w = 400;\r\n        var h = 290;\r\n        var panel = new InfoPanel((UI.getGameWidth() - w) / 2, (UI.getGameHeight() - h) / 2, w, h, 'Welcome');\r\n        panel.setWrap(20);\r\n\r\n        var x = 15;\r\n        var y = 20;\r\n        UI.textsData['welcome'].forEach(function(t){\r\n            var txt = panel.addText(x,y,t);\r\n            y += txt.height+3;\r\n        });\r\n\r\n        panel.addBigButton('Got it');\r\n        panel.display();\r\n    }\r\n\r\n    if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) TutorialManager.boot(1);\r\n\r\n\r\n    // todo: move all to dedicated sound manager\r\n    /*Engine.lastOrientationSound = 0;\r\n    // todo: move to JSON file (+ config for delay)\r\n    Engine.ambientSounds([\r\n        {name:'birds1',volume:1},\r\n        {name:'birds2',volume:1},\r\n        {name:'birds3',volume:1},\r\n        {name:'bird',volume:1},\r\n        {name:'cricket',volume:1}\r\n    ], 10000);\r\n    Engine.ambientSounds([\r\n        {name:'wind1',volume:1},\r\n        {name:'wind2',volume:1},\r\n        {name:'wind3',volume:1}\r\n    ],17000);*/\r\n};\r\n\r\nEngine.ambientSounds = function(sounds,interval){\r\n    setInterval(function(){\r\n        var sound = Utils.randomElement(sounds);\r\n        Engine.scene.sound.add(sound.name).setVolume(sound.volume).play();\r\n    },interval);\r\n};\r\n\r\nEngine.playLocalizedSound = function(sound,maxVolume,location){\r\n    var volume = maxVolume;\r\n    var dist = Utils.manhattan(location,{x:Engine.player.tileX,y:Engine.player.tileY});\r\n    var hearingDistance = Engine.config.hearingDistance;\r\n    if(dist < hearingDistance){\r\n        var d = hearingDistance-dist;\r\n        //volume = Math.round(Utils.clamp(d/Engine.hearingDistance,0,1)*maxVolume);\r\n        volume = Utils.clamp(d/hearingDistance,0,1)*maxVolume;\r\n        Engine.scene.sound.add(sound).setVolume(volume).play();\r\n    }\r\n};\r\n\r\nEngine.createAnimations = function(){\r\n    Engine.createHumanoidAnimations('player','hero');\r\n    Engine.createHumanoidAnimations('enemy','enemy');\r\n\r\n    Engine.createWolfAnimations('graywolf');\r\n    Engine.createWolfAnimations('blackwolf');\r\n    Engine.createWolfAnimations('whitewolf');\r\n\r\n    // Bear\r\n    Engine.createAnimation('bear_move_down','bears',9,11,10,true);\r\n    Engine.createAnimation('bear_move_left','bears',21,23,10,true);\r\n    Engine.createAnimation('bear_move_right','bears',33,35,10,true);\r\n    Engine.createAnimation('bear_move_up','bears',45,47,10,true);\r\n\r\n    Engine.createAnimation('bear_rest_down','bears',9,9);\r\n    Engine.createAnimation('bear_rest_left','bears',21,21);\r\n    Engine.createAnimation('bear_rest_right','bears',33,33);\r\n    Engine.createAnimation('bear_rest_up','bears',45,45);\r\n\r\n    Engine.scene.anims.create({\r\n        key: 'sword',\r\n        frames: Engine.scene.anims.generateFrameNumbers('sword_anim', { start: 0, end: 2}),\r\n        frameRate: 15,\r\n        hideOnComplete: true,\r\n        // TODO: test if callback still called after v3.3\r\n         onComplete: function(sprite){\r\n            sprite.recycle();\r\n        }\r\n    });\r\n\r\n    Engine.scene.anims.create({\r\n        key: 'explosion',\r\n        frames: Engine.scene.anims.generateFrameNumbers('explosion', { start: 0, end: 80}),\r\n        frameRate: 75,\r\n        hideOnComplete: true,\r\n        // TODO: test if callback still called after v3.3\r\n        onComplete: function(sprite){\r\n            sprite.recycle();\r\n        }\r\n    });\r\n\r\n    Engine.scene.anims.create({\r\n        key: 'player_death',\r\n        frames: Engine.scene.anims.generateFrameNumbers('hero', { start: 260, end: 265}),\r\n        frameRate: 10\r\n    });\r\n\r\n    Engine.scene.anims.create({\r\n        key: 'butterflap',\r\n        frames: Engine.scene.anims.generateFrameNumbers('butterfly', { start: 0, end: 1}),\r\n        frameRate: 5,\r\n        repeat: -1\r\n    });\r\n};\r\n\r\nEngine.createHumanoidAnimations = function(key, texture){\r\n    // TODO: don't hardcode, store in JSON of find a way to infer it\r\n    // (standardize all spritesheets?)\r\n    Engine.createAnimation(key+'_move_right',texture,143,151,15,10,true);\r\n    Engine.createAnimation(key+'_move_up',texture,104,112,15,10,true);\r\n    Engine.createAnimation(key+'_move_down',texture,130,138,15,10,true);\r\n    Engine.createAnimation(key+'_move_left',texture,117,125,15,10,true);\r\n\r\n    Engine.createAnimation(key+'_attack_right',texture,195,200,15,false,true);\r\n    Engine.createAnimation(key+'_attack_down',texture,182,187,15,false,true);\r\n    Engine.createAnimation(key+'_attack_left',texture,169,174,15,false,true);\r\n    Engine.createAnimation(key+'_attack_up',texture,156,161,15,false,true);\r\n\r\n    Engine.createAnimation(key+'_bow_right',texture,247,259,15,false,true);\r\n    Engine.createAnimation(key+'_bow_down',texture,234,246,15,false,true);\r\n    Engine.createAnimation(key+'_bow_left',texture,221,233,15,false,true);\r\n    Engine.createAnimation(key+'_bow_up',texture,208,220,15,false,true);\r\n\r\n    Engine.createAnimation(key+'_rest_down',texture,130,130);\r\n    Engine.createAnimation(key+'_rest_left',texture,117,117);\r\n    Engine.createAnimation(key+'_rest_right',texture,143,143);\r\n    Engine.createAnimation(key+'_rest_up',texture,104,104);\r\n};\r\n\r\nEngine.createWolfAnimations = function(key){\r\n    Engine.createAnimation(key+'_move_down',key,0,2,10,true);\r\n    Engine.createAnimation(key+'_move_left',key,7,9,10,true);\r\n    Engine.createAnimation(key+'_move_right',key,14,16,10,true);\r\n    Engine.createAnimation(key+'_move_up',key,21,23,10,true);\r\n\r\n    Engine.createAnimation(key+'_attack_down',key,28,34,15,false,true);\r\n    Engine.createAnimation(key+'_attack_left',key,35,41,15,false,true);\r\n    Engine.createAnimation(key+'_attack_right',key,42,48,15,false,true);\r\n    Engine.createAnimation(key+'_attack_up',key,49,55,15,false,true);\r\n\r\n    Engine.createAnimation(key+'_die_down',key,56,58);\r\n    Engine.createAnimation(key+'_die_left',key,63,65);\r\n    Engine.createAnimation(key+'_die_right',key,70,72);\r\n    Engine.createAnimation(key+'_die_up',key,77,79);\r\n\r\n    Engine.createAnimation(key+'_rest_down',key,1,1);\r\n    Engine.createAnimation(key+'_rest_left',key,8,8);\r\n    Engine.createAnimation(key+'_rest_right',key,15,15);\r\n    Engine.createAnimation(key+'_rest_up',key,22,22);\r\n};\r\n\r\nEngine.createAnimation = function(key,texture,start,end,rate,loop,revert){\r\n    rate = rate || 10;\r\n    var config = {\r\n        key: key,\r\n        frames: Engine.scene.anims.generateFrameNumbers(texture, { start: start, end: end}),\r\n        frameRate: rate\r\n    };\r\n    if(loop) config.repeat = -1;\r\n    if(revert) config.frames.push({key:texture, frame:start}); // adds the initial frame as the last frame\r\n    Engine.scene.anims.create(config);\r\n};\r\n\r\nEngine.toggleChatBar = function(){\r\n    if(Engine.inMenu && !BattleManager.inBattle) return;\r\n    Engine.chatBar.toggle();\r\n};\r\n\r\nEngine.manageDeath = function(){\r\n    Engine.dead = true;\r\n};\r\n\r\nEngine.manageRespawn = function(){\r\n    Engine.showMarker();\r\n    Engine.dead = false;\r\n    Engine.updateAllOrientationPins();\r\n};\r\n\r\nEngine.updateAllOrientationPins = function(){\r\n    Engine.entityManager.displayLists['animal'].forEach(function(aid){\r\n        Engine.animals[aid].manageOrientationPin();\r\n    });\r\n    Engine.entityManager.displayLists['civ'].forEach(function(cid){\r\n        Engine.civs[cid].manageOrientationPin();\r\n    });\r\n    Engine.orientationPins = {\r\n        'top': {},\r\n        'left': {},\r\n        'right': {},\r\n        'bottom': {}\r\n    };\r\n    Engine.entityManager.displayLists['item'].forEach(function(iid){\r\n        Engine.items[iid].manageOrientationPin();\r\n    });\r\n    // Engine.pruneOrientationPins();\r\n    Engine.entityManager.displayLists['player'].forEach(function(pid){\r\n        Engine.players[pid].manageOrientationPin();\r\n    });\r\n};\r\n\r\nEngine.pruneOrientationPins = function(){\r\n    // TODO: complete\r\n    for(var side in Engine.orientationPins){\r\n        if(side != 'right') continue; // TODO: remove\r\n        for(var item in Engine.orientationPins[side]){\r\n            var pins = Engine.orientationPins[side];\r\n            for(var i = 0; i < pins.length; i++){\r\n                var base = pins[i];\r\n                for(var j = i+1; j < pins.length; j++) {\r\n                    var other = pins[j];\r\n                    // TODO: conf\r\n                    var d = Math.abs(base.y - other.y);\r\n                    console.warn(d);\r\n                    if(d < 20){\r\n                        other.hide();\r\n                        pins.splice(j,1);\r\n                        base += d/2;\r\n                    }\r\n                }\r\n                // if(i >= pins.length) break;\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nEngine.updateBehindness = function(){\r\n    Engine.entityManager.displayLists['item'].forEach(function(iid){\r\n        Engine.items[iid].manageBehindness();\r\n    });\r\n};\r\n\r\nEngine.makeBuildingTitle = function(){\r\n    Engine.buildingTitle = new BuildingTitle(512,10);\r\n};\r\n\r\n// #############################\r\n\r\nfunction dummyRect(x,y,w,h,color){\r\n    var rect = UI.scene.add.rectangle(x, y, w, h, (color || 0x6666ff));\r\n    rect.setDepth(0).setScrollFactor(0).setOrigin(0);\r\n    return rect;\r\n}\r\n\r\nfunction dummyText(x,y,txt,size,leftAlign){\r\n    var t = UI.scene.add.text(x, y, txt, { font: size+'px belwe', fill: '#ffffff', stroke: '#000000', strokeThickness: 4 });\r\n    t.setDepth(1).setScrollFactor(0);\r\n    if(leftAlign){\r\n        t.setOrigin(0);\r\n    }else{\r\n        t.setOrigin(0.5);\r\n    }\r\n    return t;\r\n}\r\n\r\nfunction dummyImage(x,y,frame){\r\n    var img = UI.scene.add.sprite(x,y,'dummy',frame);\r\n    img.setDepth(2).setScrollFactor(0);\r\n    return img;\r\n}\r\n\r\nEngine.makeDummyUI = function(){\r\n    var sceneW = 1024;\r\n    var sceneH = 576;\r\n\r\n    dummyRect(0,0,sceneW,32);\r\n\r\n    var x = 8;\r\n    dummyImage(x,8,'citizens');\r\n    x += 8;\r\n    var t = dummyText(x,0,'2/21',14,true);\r\n    x += t.width+10;\r\n    dummyImage(x,8,'meat');\r\n    x += 8;\r\n    t = dummyText(x,0,'150/250',14,true);\r\n    x += t.width+10;\r\n    dummyText(x,0,'Famine!',14,true);\r\n\r\n    t = dummyText(sceneW/2,16,'New Beginning',16);\r\n    dummyImage(t.x - t.width/2 - 10,16,'bell');\r\n    dummyText(sceneW/2+60,25,'Lvl 3',14);\r\n\r\n    //Engine.miniMap = new MiniMap(2);\r\n    //dummyImage(sceneW-22,22,'UI','icon_holder');\r\n    //dummyImage(sceneW-172,22,'UI','icon_holder');\r\n    dummyImage(sceneW-22,22,'compass');\r\n\r\n    var h = 32;\r\n    dummyRect(0,sceneH-h,sceneW,h);\r\n\r\n    dummyText(0,sceneH-h,'100/150   Tired   100/500   3/12',14,true);\r\n    dummyRect(3,sceneH-(h/2)+2,200,10,0xef0000);\r\n\r\n    dummyText(sceneW/2,sceneH-h/2,'This is a notification',14);\r\n};\r\n\r\n// #############################\r\n\r\nfunction SettlementCapsule(x,y){\r\n    this.slices = [];\r\n    var w = 70;\r\n    this.slices.push(UI.scene.add.tileSprite(x,y,w,24,'UI','capsule-middle').setOrigin(1,0));\r\n    this.slices.push(UI.scene.add.sprite(x-w,y,'UI','capsule-left').setOrigin(1,0));\r\n    this.text = UI.scene.add.text(x-w+10, y, '',\r\n        { font: '16px belwe', fill: '#ffffff', stroke: '#000000', strokeThickness: 3 }\r\n    ).setOrigin(1,0);\r\n}\r\n\r\nSettlementCapsule.prototype.setText = function(text){\r\n    var tx = this.text.width;\r\n    this.text.setText(text);\r\n    var delta = this.text.width - tx - 20;\r\n\r\n    this.slices[0].width += delta;\r\n    this.slices[1].x -= delta;\r\n};\r\n\r\nSettlementCapsule.prototype.display = function(){\r\n    this.slices.forEach(function(slice){\r\n        slice.setVisible(true);\r\n    });\r\n    this.text.setVisible(true);\r\n};\r\n\r\nSettlementCapsule.prototype.hide = function(){\r\n    this.slices.forEach(function(slice){\r\n        slice.setVisible(false);\r\n    });\r\n    this.text.setVisible(false);\r\n};\r\n\r\nEngine.toggleMenuIcons = function(){\r\n    Engine.menuIcons.forEach(function(i){\r\n        i.toggle();\r\n    });\r\n};\r\n\r\nEngine.hideHUD = function(){\r\n    if(Engine.miniMap) Engine.miniMap.hide();\r\n    Engine.setlCapsule.hide();\r\n    Engine.toggleMenuIcons();\r\n};\r\n\r\nEngine.displayHUD = function(){\r\n    if(Engine.miniMap)  Engine.miniMap.display();\r\n    Engine.setlCapsule.display();\r\n    Engine.toggleMenuIcons();\r\n};\r\n\r\nEngine.hideCapsules = function(){\r\n    Engine.lifeCapsule.hide();\r\n    Engine.goldCapsule.hide();\r\n    Engine.bagCapsule.hide();\r\n    Engine.vigorCapsule.hide();\r\n    Engine.foodCapsule.hide();\r\n    Engine.face.setVisible(false);\r\n    Engine.faceHolder.setVisible(false);\r\n};\r\n\r\nEngine.displayCapsules = function(){\r\n    Engine.lifeCapsule.display();\r\n    Engine.goldCapsule.display();\r\n    Engine.bagCapsule.display();\r\n    Engine.vigorCapsule.display();\r\n    Engine.foodCapsule.display();\r\n    Engine.face.setVisible(true);\r\n    Engine.faceHolder.setVisible(true);\r\n};\r\n\r\n// Called after the Hero is set up\r\nEngine.makeUI = function(){\r\n    // TODO: make a zone with onpointerover = cursor is over UI, and make slices not interactive anymore\r\n    //Engine.UIHolder = new UIHolder(1000,500,'right');\r\n\r\n    var bug = UI.scene.add.image(Engine.getGameConfig().width-10,10,'bug');\r\n    bug.setOrigin(1,0);\r\n    bug.setScrollFactor(0);\r\n    bug.setInteractive();\r\n    bug.setDepth(10);\r\n\r\n    bug.on('pointerup',Engine.snap);\r\n    bug.on('pointerover',function(){\r\n        UI.tooltip.updateInfo('free',{body:'Snap a pic of a bug'});\r\n        UI.tooltip.display();\r\n    });\r\n    bug.on('pointerout',UI.tooltip.hide.bind(UI.tooltip));\r\n\r\n    Engine.miniMap = new MiniMap();\r\n    Engine.setlCapsule = new SettlementCapsule(950,3);\r\n\r\n    var x = 23;\r\n    var y = 19;\r\n    Engine.faceHolder = UI.scene.add.sprite(x,y,'UI','facebg').setScrollFactor(0).setDepth(2);\r\n    Engine.face = UI.scene.add.sprite(x,y,'faces',0).setScrollFactor(0).setDepth(3);\r\n\r\n    Engine.lifeCapsule = new Capsule(37,3,'UI','heart');\r\n    Engine.lifeCapsule.setHoverText('Vitality',UI.textsData['health_help']);\r\n    Engine.lifeCapsule.removeLeft();\r\n    Engine.lifeCapsule.display();\r\n    Engine.lifeCapsule.update = function(){\r\n        this.setText(Engine.player.getStatValue('hp')+'/'+Engine.player.getStatValue('hpmax'));\r\n    };\r\n\r\n    Engine.goldCapsule = new Capsule(152,3,'UI','gold');\r\n    Engine.goldCapsule.setHoverText('Gold',UI.textsData['gold_help']);\r\n    Engine.goldCapsule.display();\r\n    Engine.goldCapsule.update = function(){\r\n        this.setText(Engine.player.gold || 0); // TODO: add max\r\n    };\r\n    Engine.goldCapsule.update();\r\n\r\n    Engine.bagCapsule = new Capsule(228,3,'UI','smallpack');\r\n    Engine.bagCapsule.setHoverText('Backpack',UI.textsData['backpack_help']);\r\n    Engine.bagCapsule.display();\r\n    Engine.bagCapsule.update = function(){\r\n        this.setText(Engine.player.inventory.size+'/'+Engine.player.inventory.maxSize);\r\n    };\r\n    Engine.bagCapsule.update();\r\n\r\n    Engine.vigorCapsule = new Capsule(50,30,'UI','goldenheart');\r\n    Engine.vigorCapsule.setHoverText('Vigor',UI.textsData['vigor_help']);\r\n    Engine.vigorCapsule.display();\r\n    Engine.vigorCapsule.update = function(){\r\n        this.setText(Engine.player.getStatValue('vigor')+'%');\r\n    };\r\n\r\n    Engine.foodCapsule = new Capsule(140,30,'UI','bread');\r\n    Engine.foodCapsule.setHoverText('Food',UI.textsData['food_help']);\r\n    Engine.foodCapsule.display();\r\n    Engine.foodCapsule.update = function(){\r\n        this.setText(Engine.player.getStatValue('food')+'%');\r\n    };\r\n\r\n    Engine.capsules = {\r\n        update: function(){\r\n            Engine.lifeCapsule.update();\r\n            Engine.foodCapsule.update();\r\n            Engine.vigorCapsule.update();\r\n        }\r\n    };\r\n    Engine.capsules.update();\r\n\r\n    Engine.makeBuildingTitle();\r\n\r\n    var statsPanel = new StatsPanel(665,335,330,100,'Stats');\r\n    statsPanel.addButton(300, 8, 'blue','help',null,'',UI.textsData['stats_help']);\r\n\r\n    // Todo: make a 'makerepairpanel()' method similar to 'makepricespanel()'?\r\n    Engine.repairPanel = new RepairPanel(476,120,500,200,'Repair');\r\n    Engine.repairPanel.addButton(500-16,-8,'red','close',Engine.repairPanel.hide.bind(Engine.repairPanel),'Close');\r\n    Engine.repairPanel.addButton(460, 8, 'blue','help',null,'',UI.textsData['repair_help']);\r\n    Engine.repairPanel.moveUp(2);\r\n    Engine.repairAction = new ShopPanel(670,310,300,100,'Take'); \r\n    Engine.repairAction.addButton(300-16,-8,'red','close',Engine.repairAction.hide.bind(Engine.repairAction),'Close');\r\n    Engine.repairAction.moveUp(2);\r\n\r\n    Engine.menus = {\r\n        'abilities': Engine.makeAbilitiesMenu(),\r\n        'battle': Engine.makeBattleMenu(),\r\n        'build': Engine.makeBuildMenu(),\r\n        'character': Engine.makeCharacterMenu(),\r\n        'construction': Engine.makeConstructionMenu(),\r\n        'crafting': Engine.makeCraftingMenu(),\r\n        'inventory': Engine.makeInventory(statsPanel),\r\n        'map': Engine.makeMapMenu(),\r\n        //'messages': Engine.makeMessagesMenu(),\r\n        'production': Engine.makeProductionMenu(),\r\n        'respawn': Engine.makeRespawnMenu(),\r\n        'rest': Engine.makeRestMenu(),\r\n        'trade': Engine.makeTradeMenu(),\r\n        'wip': Engine.makeWipMenu()\r\n    };\r\n\r\n    Engine.menuIcons = [];\r\n    //Engine.addMenu(1004,140,'menu_crow',Engine.menus.messages,895,73);\r\n    Engine.addMenu(967,150,'menu_map',Engine.menus.map,855,73);\r\n    Engine.addMenu(922,150,'menu_backpack',Engine.menus.inventory,815,73);\r\n    Engine.addMenu(884,130,'menu_dude',Engine.menus.character,775,73);\r\n    //Engine.addMenu(863,95,'menu_flag',Engine.menus.inventory,735,73);\r\n    Engine.addMenu(20,60,'shovel',Engine.menus.build,-100,60);\r\n\r\n    Engine.makeBattleUI();\r\n\r\n    var chatw = 230;\r\n    var chath = 50;\r\n    var chaty = Engine.getGameConfig().height - chath;\r\n    Engine.chatBar = new ChatPanel(0,chaty,chatw,chath,'Chat');\r\n\r\n    // TODO: make conditional to unread\r\n    /*letter.tween = UI.scene.tweens.add(\r\n        {\r\n            targets: letter,\r\n            y: '-=20',\r\n            duration: 400,\r\n            yoyo: true,\r\n            repeat: -1,\r\n            ease: 'Quad.easeOut',\r\n            onRepeat: function(_tween, _sprite){\r\n                if(_sprite.flagForStop) _tween.stop();\r\n            }\r\n        }\r\n    );*/\r\n};\r\n\r\n\r\n\r\nEngine.addMenu = function(x,y,icon,menu,tox,toy){\r\n    Engine.menuIcons.push(new _menuIcon__WEBPACK_IMPORTED_MODULE_2__[\"default\"](x,y,icon,menu,tox,toy));\r\n};\r\n\r\nEngine.makeBattleUI = function(){\r\n    Engine.fightText = UI.scene.add.text(Engine.getGameConfig().width/2,50, 'Fight!',  { font: '45px belwe', fill: '#ffffff', stroke: '#000000', strokeThickness: 3 });\r\n    Engine.fightText.setOrigin(0.5);\r\n    Engine.fightText.setScrollFactor(0);\r\n    Engine.fightText.setDepth(3);\r\n    Engine.fightText.setVisible(false);\r\n};\r\n\r\nEngine.tweenFighText = function(){\r\n    UI.scene.tweens.add(\r\n        {\r\n            targets: Engine.fightText,\r\n            scaleX: 1,\r\n            scaleY: 1,\r\n            duration: 100,\r\n            onStart: function(){\r\n                Engine.fightText.setScale(10);\r\n                Engine.fightText.setVisible(true);\r\n            },\r\n            onComplete: function(){\r\n                setTimeout(function(){\r\n                    Engine.fightText.setVisible(false);\r\n                },1000);\r\n            }\r\n        }\r\n    );\r\n};\r\n\r\nEngine.isProduced = function(item){\r\n    return Engine.currentBuiling.produced.includes(parseInt(item));\r\n};\r\n\r\nEngine.handleBattleAnimation = function(data){\r\n    var sprite = Engine.animationsPools[data.name].getNext();\r\n    sprite.setVisible(false);\r\n    sprite.setOrigin(0.5);\r\n    var x = data.x*Engine.tileWidth;\r\n    var y = data.y*Engine.tileHeight;\r\n    sprite.setPosition(x,y);\r\n    sprite.setDepth(5);\r\n    sprite.on('animationstart',function(){\r\n        var sound = data.sound || 'hit';\r\n        Engine.playLocalizedSound(sound,1,{x:data.x,y:data.y});\r\n    });\r\n    setTimeout(function(){\r\n        sprite.setVisible(true);\r\n        sprite.anims.play(data.name);\r\n        if(data.sound == 'bomb') Engine.camera.shake(300,0.01);\r\n    },data.delay);\r\n};\r\n\r\nEngine.animateRangeAmmo = function(frame, from, to, depth, duration, delay, imagePool){ // All coordinates are pixels\r\n\r\n    // TODO: refactor the whole pool thing and getNext only when you know that it's the right pool\r\n    let arrow = Engine.arrowsPool.getNext();\r\n\r\n    if(imagePool){\r\n        arrow = imagePool.getNext();\r\n    }\r\n\r\n    arrow.setFrame(frame);\r\n    arrow.setPosition(from.x+16,from.y+16);\r\n    arrow.setDepth(depth);\r\n    arrow.setVisible(false);\r\n\r\n    var destx = (parseFloat(to.x))*32;\r\n    var desty = (parseFloat(to.y))*32;\r\n    console.log(destx,desty);\r\n\r\n    var angle = Phaser.Math.Angle.Between(from.x,from.y,destx,desty)*(180/Math.PI);\r\n    arrow.setAngle(angle + 45);\r\n\r\n    Engine.scene.tweens.add(\r\n        {\r\n            targets: arrow,\r\n            x: destx,\r\n            y: desty,\r\n            duration: duration,\r\n            delay: delay,\r\n            onComplete: function(){\r\n                arrow.recycle();\r\n            }\r\n        }\r\n    );\r\n    Engine.playLocalizedSound('arrow',4,{x:from.x/32,y:from.y/32});\r\n    setTimeout(function(){\r\n        arrow.setVisible(true);\r\n    },delay);\r\n};\r\n\r\nEngine.displayBomb = function(from,to,depth,duration,delay){ // All coordinates are pixels\r\n    var bomb = Engine.bombsPool.getNext();\r\n    bomb.setFrame('bomb');\r\n    bomb.setPosition(from.x+16,from.y+16);\r\n    bomb.setDepth(depth);\r\n    bomb.setVisible(false);\r\n\r\n    Engine.scene.tweens.add(\r\n        {\r\n            targets: bomb,\r\n            x: (parseInt(to.x)+0.5)*32,\r\n            y: (parseInt(to.y)+0.5)*32,\r\n            angle: '+=360',\r\n            duration: duration,\r\n            delay: delay,\r\n            onComplete: function(){\r\n                bomb.recycle();\r\n            }\r\n        }\r\n    );\r\n    setTimeout(function(){\r\n        bomb.setVisible(true);\r\n    },delay);\r\n};\r\n\r\nEngine.displayHit = function(target,x,y,size,yDelta,dmg,miss,delay){\r\n    var text = Engine.textPool.getNext();\r\n    text.setStyle({ font: 'belwe', fontSize: size, fill: '#ffffff', stroke: '#000000', strokeThickness: 3 });\r\n    text.setFont(size+'px belwe');\r\n    text.setOrigin(0.5,1);\r\n    text.setPosition(x,y);\r\n    text.setDepth(target.depth+1);\r\n    text.setText(miss ? 'Miss' : '-'+dmg);\r\n    text.setVisible(false);\r\n\r\n    // HP tween\r\n    Engine.scene.tweens.add(\r\n        {\r\n            targets: text,\r\n            y: target.y-yDelta,\r\n            duration: 1000,\r\n            delay: delay,\r\n            onComplete: function(){\r\n                text.recycle();\r\n            }\r\n        }\r\n    );\r\n    setTimeout(function(){\r\n        if(miss) Engine.playLocalizedSound('arrow_miss',4,{x:x/32,y:y/32});\r\n        text.setVisible(true);\r\n    },delay);\r\n\r\n    if(miss) return;\r\n    // Blink tween\r\n    if(target.blinkTween) target.blinkTween.stop();\r\n    target.blinkTween = Engine.scene.tweens.add(\r\n        {\r\n            targets: target,\r\n            alpha: 0,\r\n            duration: 100,\r\n            delay: delay,\r\n            yoyo: true,\r\n            repeat: 3,\r\n            onStart: function(){\r\n                target.setAlpha(1); // so that if it takes over another tween immediately, it starts from the proper alpha value\r\n            },\r\n            onComplete: function(){\r\n                target.setAlpha(1);\r\n            }\r\n        });\r\n\r\n};\r\n\r\nEngine.getPlayerHealth = function(){\r\n    return Engine.player.getStatValue('hp');\r\n};\r\n\r\nEngine.getPlayerMaxHealth = function(){\r\n    return Engine.player.getStatValue('hpmax');\r\n};\r\n\r\nEngine.makeRespawnMenu = function(){\r\n    var menu = new Menu();\r\n    menu.fullHide = true;\r\n    var respawnw = 300;\r\n    var respawnh = 90;\r\n    var respawnx = (Engine.getGameConfig().width-respawnw)/2;\r\n    var respawny = 400;\r\n    var respawn = menu.addPanel('respawn',new RespawnPanel(respawnx,respawny,respawnw,respawnh));\r\n    respawn.addButton(respawnw-30, 8, 'blue','help',null,'',UI.textsData['respawn_help']);\r\n    return menu;\r\n};\r\n\r\nEngine.makeBattleMenu = function(){\r\n    var battle = new Menu();\r\n    battle.fullHide = true;\r\n\r\n    var equipment = battle.addPanel('equipment',new BattleEquipmentPanel());\r\n\r\n    var belt = battle.addPanel('belt',new InventoryPanel(0,487,200,90,'Belt'));\r\n    belt.setInventory('belt',5,true,BattleManager.processInventoryClick);\r\n\r\n    battle.addEvent('onUpdateBelt',belt.updateInventory.bind(belt));\r\n    battle.addEvent('onUpdateEquipment',equipment.updateEquipment.bind(equipment));\r\n    battle.addEvent('onUpdateStats',equipment.updateStats.bind(equipment));\r\n\r\n    battle.addEvent('onOpen',function(){\r\n        belt.updateInventory();\r\n        equipment.updateEquipment();\r\n        equipment.updateStats();\r\n        equipment.updateCapsules();\r\n        Engine.hideCapsules();\r\n    });\r\n\r\n    battle.addEvent('onClose',function(){\r\n        Engine.displayCapsules();\r\n    });\r\n\r\n    return battle;\r\n};\r\n\r\nEngine.makeProductionMenu = function(){\r\n    var production = new Menu('Production');\r\n    production.setTitlePos(100);\r\n    production.setExitPos(680);\r\n    var w = 400;\r\n    var h = 350;\r\n    var x = (Engine.getGameConfig().width-w)/2;\r\n    var y = 150;\r\n\r\n    var productionPanel = new ProductionPanel(x,y,w,h);\r\n    productionPanel.addButton(w-30, 8, 'blue','help',null,'',UI.textsData['prod_help']);\r\n    var gold = productionPanel.addCapsule('gold',20,20,'999','gold');\r\n    gold.setHoverText('Building gold',UI.textsData['shopgold_help']);\r\n    production.addPanel('production',productionPanel);\r\n\r\n    var action = new ShopPanel(212,440,300,100,'Take',true); // true = not shop, hack\r\n    action.addButton(300-16,-8,'red','close',action.hide.bind(action),'Close');\r\n    action.moveUp(2);\r\n    production.addPanel('action',action,true);\r\n\r\n    var prices = production.addPanel('prices',Engine.makePricesPanel(),true);\r\n    prices.limitToProduction();\r\n\r\n    var aw = 300;\r\n    var goldaction = production.addPanel('goldaction',new ShopGoldPanel(212,390,aw,100,'Buy/Sell'),true);\r\n    goldaction.addButton(aw-16,-8,'red','close',goldaction.hide.bind(goldaction),'Close');\r\n    goldaction.moveUp(2);\r\n\r\n    production.addEvent('onUpdateShop',function(){\r\n        productionPanel.update();\r\n        action.update();\r\n    });\r\n\r\n    production.addEvent('onUpdateShopGold',function(){\r\n        productionPanel.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n    });\r\n\r\n    production.addEvent('onOpen',function(){\r\n        productionPanel.update();\r\n        action.update();\r\n        productionPanel.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n    });\r\n    return production;\r\n};\r\n\r\nEngine.makeConstructionMenu = function(){\r\n    var w = 500;\r\n    var x = (Engine.getGameConfig().width-w)/2;\r\n    var progressh = 300;\r\n    var progressy = 150;\r\n\r\n    var constr = new Menu('Construction');\r\n    constr.setTitlePos(100);\r\n    constr.setExitPos(720);\r\n\r\n    var progress = new ConstructionPanel(x,progressy,w,progressh);\r\n    progress.addButton(w-30, 8, 'blue','help',null,'',UI.textsData['progress_help']);\r\n    constr.addPanel('progress',progress);\r\n    var gold = progress.addCapsule('gold',20,-9,'999','gold');\r\n    gold.setHoverText('Building gold',UI.textsData['shopgold_help']);\r\n\r\n    var aw = 300;\r\n    var action = constr.addPanel('action',new ShopPanel(212,390,aw,100,'Give',true),true);\r\n    action.addButton(aw-16,-8,'red','close',action.hide.bind(action),'Close');\r\n    action.moveUp(2);\r\n\r\n    var goldaction = constr.addPanel('goldaction',new ShopGoldPanel(212,390,aw,100,'Buy/Sell'),true);\r\n    goldaction.addButton(aw-16,-8,'red','close',goldaction.hide.bind(goldaction),'Close');\r\n    goldaction.moveUp(2);\r\n\r\n    constr.addPanel('prices',Engine.makePricesPanel(),true);\r\n\r\n    constr.addEvent('onUpdateShop',function(){\r\n        progress.update();\r\n        action.update();\r\n    });\r\n\r\n    constr.addEvent('onUpdateShopGold',function(){\r\n        progress.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n    });\r\n\r\n    constr.addEvent('onOpen',function(){\r\n        progress.update();\r\n        progress.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n        action.update();\r\n    });\r\n\r\n    return constr;\r\n};\r\n\r\nEngine.makeWipMenu = function(){\r\n    var menu = new Menu();\r\n    menu.setTitlePos(100);\r\n    menu.setExitPos(730 );\r\n    var w = 500;\r\n    var x = (Engine.getGameConfig().width-w)/2;\r\n\r\n    var panel = menu.addPanel('main',new InfoPanel(x,150,w,300));\r\n    var txt = panel.addText(110,150,'Nothing to do here (yet)',null,24);\r\n\r\n    return menu;\r\n};\r\n\r\nEngine.makeRestMenu = function(){\r\n    var menu = new Menu();\r\n    menu.setTitlePos(100);\r\n    menu.setExitPos(670);\r\n    var w = 400;\r\n    var x = (Engine.getGameConfig().width-w)/2;\r\n\r\n    var panel = menu.addPanel('main',new RestPanel(x,150,w,200));\r\n    panel.addButton(w - 30, 8, 'blue','help',null,'',UI.textsData['shack_help']);\r\n    menu.addEvent('onUpdateStats',panel.update.bind(panel));\r\n\r\n    return menu;\r\n};\r\n\r\nEngine.makeMessagesMenu = function(){\r\n    var title = UI.textsData['intro_title'];\r\n\r\n    var menu = new Menu('Letters');\r\n    menu.setSound(Engine.scene.sound.add('page_turn3'));\r\n    var x = 150;\r\n    var listw = 250;\r\n    var gap = 20;\r\n    var list = menu.addPanel('list',new MessagesPanel(x,100,listw,380,'Letters'));\r\n    list.addMessages([{\r\n        name: title\r\n    }]);\r\n    var msg = menu.addPanel('msg',new InfoPanel(x+listw+gap,100,500,380,'Selected letter'));\r\n    msg.makeScrollable(); // TODO: only if text too long\r\n\r\n    var x = 15;\r\n    var y = 20;\r\n    UI.textsData['intro_letter'].forEach(function(t){\r\n        t = t.replace(/\\[SETL\\]/, Engine.settlementsData[Engine.player.settlement].name);\r\n        t = t.replace(/\\[OTSETL\\]/, Engine.settlementsData[1-Engine.player.settlement+0].name); // quick fix\r\n        var txt = msg.addText(x,y,t);\r\n        y += txt.height+3;\r\n    });\r\n\r\n    /*menu.addEvent('onOpen',function(){\r\n        Engine.UIelements[0].flagForStop = true;\r\n    });*/\r\n\r\n    return menu;\r\n};\r\n\r\nEngine.makeMapMenu = function(){\r\n    var map = new Menu('World Map');\r\n    map.log = true;\r\n    map.hook = 'map';\r\n    map.setSound(Engine.scene.sound.add('page_turn2'));\r\n    var mapPanel = map.addPanel('map',new MapPanel(10,100,1000,380,'',true)); // true = invisible\r\n    // mapPanel.addBackground('longscroll');\r\n    mapPanel.addBackground('bigbg');\r\n    mapPanel.addLegend();\r\n    // var mapInstance = mapPanel.addMap('radiallongrect',900,380,-1,-1);\r\n    var mapInstance = mapPanel.addMap('bigbg_mask',900,380,-1,-1);\r\n    mapPanel.addButton(950, 0, 'blue','help',null,'',UI.textsData['self_map_help']);\r\n    // TODO: move in Map.js, method addZoom, positions buttons based on viewWidt/height and\r\n    // controls enable/disable of buttons based on zoom flag\r\n    mapPanel.zoomInBtn = mapPanel.addButton(930, 390, 'blue','plus',mapInstance.zoomIn.bind(mapInstance));\r\n    mapPanel.zoomOutBtn = mapPanel.addButton(920, 420, 'blue','minus',mapInstance.zoomOut.bind(mapInstance));\r\n    map.addEvent('onUpdateMap',mapPanel.map.updatePins.bind(mapPanel.map));\r\n    return map;\r\n};\r\n\r\nEngine.makePricesPanel = function(){\r\n    var w = 415;\r\n    var h = 480;\r\n    var prices = new PricesPanel(Math.round((1024-w)/2),80,w,h,'Prices');\r\n    prices.addButton(w-16,-8,'red','close',prices.hide.bind(prices),'Close');\r\n    prices.addButton(w-40, 8, 'blue','help',null,'',UI.textsData['prices_help']);\r\n    prices.moveUp(4);\r\n    return prices;\r\n};\r\n\r\nEngine.addAdminButtons = function(panel,x,y){\r\n\r\n    panel.pricesBtn = new BigButton(x,y,'Set prices',function(){\r\n        Engine.currentMenu.displayPanel('prices');\r\n        Engine.currentMenu.hidePanel('action');\r\n        Engine.currentMenu.hidePanel('goldaction');\r\n    });\r\n\r\n    panel.ggBtn = new BigButton(x + 110,y,'Give gold',function(){\r\n        Engine.currentMenu.hidePanel('action');\r\n        var ga = Engine.currentMenu.displayPanel('goldaction');\r\n        ga.setUp('sell');\r\n    });\r\n\r\n    panel.tgBtn = new BigButton(x + 220,y,'Take gold',function(){\r\n        Engine.currentMenu.hidePanel('action');\r\n        var ga = Engine.currentMenu.displayPanel('goldaction');\r\n        ga.setUp('buy');\r\n    });\r\n};\r\n\r\nEngine.makeTradeMenu = function(){\r\n    var trade = new Menu('Trade');\r\n    trade.setTitlePos(10);\r\n    trade.setExitPos(885);\r\n    var y = 80;\r\n    var w = 400;\r\n    var h = 480;\r\n    var space = 15;\r\n    var center = Engine.getGameConfig().width/2;\r\n    var client = trade.addPanel('client',new ShopInventoryPanel(center-w-space,y,w,h,'You'));\r\n    client.setInventory('player');\r\n    var gold = client.addCapsule('gold',120,-9,'999','gold');\r\n    gold.setHoverText('Your gold',UI.textsData['gold_help']);\r\n    client.addButton(w-30, 8, 'blue','help',null,'',UI.textsData['sell_help']);\r\n    var shop =  trade.addPanel('shop',new ShopInventoryPanel(center+space,y,w,h,'Shop'));\r\n    shop.setInventory('building');\r\n    var shopgold = shop.addCapsule('gold',100,-9,'999','gold');\r\n    shopgold.setHoverText('Shop gold',UI.textsData['shopgold_help']);\r\n    shop.addButton(w-30, 8, 'blue','help',null,'',UI.textsData['buy_help']);\r\n    w = 300;\r\n    var x = (Engine.getGameConfig().width-w)/2;\r\n    var action = trade.addPanel('action',new ShopPanel(x,440,w,100,'Buy/Sell'),true);\r\n    action.addButton(w-16,-8,'red','close',action.hide.bind(action),'Close');\r\n    action.moveUp(2);\r\n    var goldaction = trade.addPanel('goldaction',new ShopGoldPanel(x,420,w,100,'Buy/Sell'),true);\r\n    goldaction.addButton(w-16,-8,'red','close',goldaction.hide.bind(goldaction),'Close');\r\n    goldaction.moveUp(2);\r\n\r\n    var prices = trade.addPanel('prices',Engine.makePricesPanel(),true);\r\n\r\n    trade.addEvent('onUpdateInventory',function(){\r\n        client.updateContent();\r\n        action.update();\r\n    });\r\n    trade.addEvent('onUpdateShop',function(){\r\n        shop.updateContent();\r\n        action.update();\r\n    });\r\n    trade.addEvent('onUpdateGold',function(){\r\n        client.updateCapsule('gold',Engine.player.gold);\r\n        Engine.scene.sound.add('sellbuy').play();\r\n        shop.updateContent();\r\n        action.update();\r\n        goldaction.update();\r\n    });\r\n    trade.addEvent('onUpdateShopGold',function(){\r\n        shop.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n        client.updateContent();\r\n        action.update();\r\n        goldaction.update();\r\n    });\r\n    trade.addEvent('onOpen',function(){\r\n        client.updateCapsule('gold',Engine.player.gold);\r\n        shop.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n        client.updateContent();\r\n        shop.updateContent();\r\n        action.update();\r\n        goldaction.update();\r\n    });\r\n    return trade;\r\n};\r\n\r\nEngine.makeCraftingMenu = function(){\r\n    var crafting = new Menu('Crafting');\r\n    crafting.setTitlePos(10);\r\n    crafting.setSound(Engine.scene.sound.add('crafting'));\r\n    crafting.setExitPos(885);\r\n\r\n    var combix = 20;\r\n    var combiw = 550;\r\n    var y = 80;\r\n    var recipesw = 400;\r\n    var h = 480;\r\n    var space = 15;\r\n\r\n    var recipes = crafting.addPanel('shop',new RecipesPanel(combix+combiw+space,y,recipesw,h,'Recipes'));\r\n    recipes.setInventory('crafting');\r\n    var gold = recipes.addCapsule('gold',120,-9,'999','gold');\r\n    gold.setHoverText('Workshop gold',UI.textsData['shopgold_help']);\r\n    recipes.addButton(recipesw-30, 8, 'blue','help',null,'',UI.textsData['recipes_help']);\r\n\r\n    var combi = crafting.addPanel('combi',new CraftingPanel(combix,y,combiw,h,'Crafting'));\r\n    combi.addButton(combiw-30, 8, 'blue','help',null,'',UI.textsData['combi_help']);\r\n\r\n    var prices = crafting.addPanel('prices',Engine.makePricesPanel(),true);\r\n    prices.limitToCrafting();\r\n\r\n    var x = (Engine.getGameConfig().width-300)/2;\r\n    var goldaction = crafting.addPanel('goldaction',new ShopGoldPanel(x,420,300,100,'Buy/Sell'),true);\r\n    goldaction.addButton(300-16,-8,'red','close',goldaction.hide.bind(goldaction),'Close');\r\n    goldaction.moveUp(2);\r\n\r\n    crafting.addEvent('onUpdateShopGold',function(){\r\n        recipes.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n        goldaction.update();\r\n    });\r\n\r\n    crafting.addEvent('onUpdateShop',function(){\r\n        recipes.updateContent();\r\n        combi.updateIngredients();\r\n    });\r\n    \r\n    crafting.addEvent('onUpdateRecipes',function(){\r\n        recipes.updateContent();\r\n    });\r\n\r\n    crafting.addEvent('onUpdateInventory',function(){\r\n        recipes.updateContent();\r\n        combi.updateIngredients();\r\n    });\r\n\r\n    crafting.addEvent('onOpen',function(){\r\n        recipes.updateContent();\r\n        recipes.updateCapsule('gold',(Engine.currentBuiling.gold || 0));\r\n    });\r\n\r\n    return crafting;\r\n};\r\n\r\nEngine.makeBuildMenu = function(){\r\n    var build = new Menu();\r\n    build.keepHUD = true;\r\n    build.allowWalk = true;\r\n    build.name = 'Build something'; // Allows to have a hover name without a menu title\r\n    build.hook = 'build';\r\n    var w = 300;\r\n    var buildings = build.addPanel('build',new BuildPanel(30,50,w,450,'Build'));\r\n    buildings.addButton(w-16,-8,'red','close',build.hide.bind(build),'Close');\r\n    buildings.addButton(w-33, 8, 'blue','help',null,'',UI.textsData['build_help']);\r\n    buildings.moveUp(2);\r\n    build.addEvent('onOpen',buildings.updateContent.bind(buildings));\r\n    build.addEvent('onUpdateBuildRecipes',buildings.updateContent.bind(buildings));\r\n    return build;\r\n};\r\n\r\nEngine.bldClick = function(){\r\n    var bld = Engine.buildingsData[this.bldID];\r\n    Engine.currentMenu.hide();\r\n\r\n    Engine.hideMarker();\r\n    Engine.bldRect = Engine.scene.add.rectangle(0,0, bld.base.width*32, bld.base.height*32, 0x00ee00).setAlpha(0.7);\r\n    Engine.bldRect.bldID = this.bldID;\r\n    Engine.bldRect.locationConstrained = bld.locationConstrained;\r\n    Engine.updateBldRect();\r\n\r\n    if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) TutorialManager.triggerHook('bldselect:'+this.bldID);\r\n};\r\n\r\nEngine.bldUnclick = function(shutdown){\r\n    if(!Engine.bldRect.collides && !shutdown) {\r\n        var id = Engine.bldRect.bldID;\r\n        //var bld = Engine.buildingsData[id];\r\n        var pos = Engine.bldRect.getBottomLeft();\r\n        pos.x = pos.x / 32;\r\n        pos.y = (pos.y / 32) - 1;\r\n        _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].sendBuild(id, pos);\r\n    }\r\n    Engine.showMarker();\r\n    Engine.bldRect.destroy();\r\n    Engine.bldRect = null;\r\n};\r\n\r\nEngine.updateBldRect = function(){\r\n    // Center coordinates ; !! marker has origin 0,0\r\n    Engine.bldRect.x = (Engine.bldRect.width%64 == 0 ? Engine.marker.x+32 : Engine.marker.x+16);\r\n    Engine.bldRect.y = (Engine.bldRect.height%64 == 0 ? Engine.marker.y+32 : Engine.marker.y+16);\r\n    var collides = false;\r\n    var invalid = false;\r\n    for(var x = 0; x < Engine.bldRect.width/32; x++){\r\n        if(collides || invalid) break;\r\n        for(var y = 0; y < Engine.bldRect.height/32; y++){\r\n            var cx = (Engine.bldRect.x-(Engine.bldRect.width/2))/32+x;\r\n            var cy = (Engine.bldRect.y-(Engine.bldRect.height/2))/32+y;\r\n            if(Engine.checkCollision(cx,cy)){\r\n                collides = true;\r\n                break;\r\n            }\r\n            if(Engine.bldRect.locationConstrained && !Engine.checkResource(cx,cy)){\r\n                invalid = true;\r\n                break;\r\n            }\r\n        }\r\n    }\r\n    Engine.bldRect.collides = (collides || invalid);\r\n    if(collides || invalid){\r\n        Engine.bldRect.setFillStyle(0xee0000);\r\n    }else{\r\n        Engine.bldRect.setFillStyle(0x00ee00);\r\n    }\r\n};\r\n\r\nEngine.makeInventory = function(statsPanel){\r\n    // ## Inventories are only displayed if a trigger calls onUpdateInventory; TODO change that!!\r\n    var inventory = new Menu('Inventory');\r\n    inventory.log = true;\r\n    inventory.setSound(Engine.scene.sound.add('inventory'));\r\n\r\n    var items = inventory.addPanel('items',new InventoryPanel(40,100,600,260,'Backpack'));\r\n    items.setInventory('player',15,true,Engine.backpackClick);\r\n\r\n    var gold = items.addCapsule('gold',130,-9,'999','gold');\r\n    gold.setHoverText('Gold',UI.textsData['gold_help']);\r\n    items.addButton(570, 8, 'blue','help',null,'',UI.textsData['inventory_help']);\r\n\r\n    inventory.addPanel('itemAction',new ItemActionPanel(70,220,300,120),true);\r\n\r\n    var belt = inventory.addPanel('belt',new InventoryPanel(40,360,600,90,'Belt'));\r\n    belt.setInventory('belt',15,true,Engine.beltClick);\r\n    belt.addButton(570, 8, 'blue','help',null,'',UI.textsData['belt_help']);\r\n\r\n    var equipment = new EquipmentPanel(665,100,330,235,'Equipment');\r\n    equipment.addButton(300, 8, 'blue','help',null,'',UI.textsData['equipment_help']);\r\n    inventory.addPanel('equipment',equipment);\r\n\r\n    inventory.addPanel('stats',statsPanel);\r\n\r\n    inventory.addEvent('onUpdateEquipment',equipment.updateEquipment.bind(equipment));\r\n    inventory.addEvent('onUpdateInventory',items.updateInventory.bind(items));\r\n    inventory.addEvent('onUpdateBelt',belt.updateInventory.bind(belt));\r\n    inventory.addEvent('onUpdateStats',statsPanel.updateStats.bind(statsPanel));\r\n    inventory.addEvent('onUpdateGold',function(){\r\n        items.updateCapsule('gold',Engine.player.gold);\r\n    });\r\n    inventory.addEvent('onOpen',function(){\r\n        equipment.updateEquipment();\r\n        items.updateInventory();\r\n        belt.updateInventory();\r\n        statsPanel.updateStats();\r\n        items.updateCapsule('gold',Engine.player.gold);\r\n    });\r\n    return inventory;\r\n};\r\n\r\nEngine.makeAbilitiesMenu = function(){\r\n    var menu = new Menu('Abilities');\r\n    menu.addPanel('abilities',new AbilitiesPanel(40,100,600,380,'Abilities'));\r\n    menu.addPanel('desc',new AbilityPanel(660,100,340,380,'Description'));\r\n    return menu;\r\n};\r\n\r\nEngine.makeCharacterMenu = function(){\r\n    var menu = new Menu('Character');\r\n    menu.log = true;\r\n    menu.setSound(Engine.scene.sound.add('page_turn'));\r\n\r\n    var citizenx = 40;\r\n    var citizeny = 100;\r\n    var citizenw = 470;\r\n    var citizenh = 200;\r\n    var gap = 10;\r\n    var classx = citizenx+citizenw+gap;\r\n    var classy = 100;\r\n    var classw = 470;\r\n    var classh = 300;\r\n    var questy = classy+classh;\r\n    var logy = citizeny+citizenh;\r\n    var questh = 380-classh;\r\n    var logh = 380 - citizenh;\r\n\r\n    //var citizen = menu.addPanel('citizen', new CitizenPanel(citizenx,citizeny,citizenw,citizenh,'Civic status'));\r\n    var log = menu.addPanel('log', new JournalPanel(citizenx,citizeny,citizenw,logh+citizenh,'Journal'));\r\n\r\n    var classpanel = menu.addPanel('class', new CharacterPanel(classx,classy,classw,classh,'Multi-Class status'));\r\n    var sx = classx + 15;\r\n    var cx = sx;\r\n    var cy = classy + 30;\r\n    var cw = Math.round((classw - 45)/2);\r\n    var ch = (classh - 100)/2;\r\n    for(var classID in UI.classesData) {\r\n        var p = menu.addPanel('class_'+classID, new ClassMiniPanel(cx,cy,cw,ch,UI.classesData[classID].name,classID));\r\n        cx += cw + 15;\r\n        if(classID == 1){\r\n            cx = sx;\r\n            cy += ch;\r\n        }\r\n\r\n        //var ab = menu.addPanel('abilities_'+classID, new Panel(citizenx,citizeny,citizenw,citizenh,'Abilities'), true);\r\n        //ab.addButton(citizenw,-8,'red','close',ab.hide.bind(ab),'Close');\r\n    }\r\n\r\n    var quests = menu.addPanel('quests', new Panel(classx,questy,classw,questh,'Daily quests'));\r\n\r\n    //menu.addPanel('abilities',new Panel(citizenx,citizeny,citizenw,citizenh),true);\r\n\r\n    menu.addEvent('onUpdateCharacter',classpanel.update.bind(classpanel));\r\n    menu.addEvent('onUpdateHistory',log.update.bind(log));\r\n    menu.addEvent('onOpen',log.update.bind(log));\r\n    //menu.addEvent('onUpdateCitizen',citizen.update.bind(citizen));\r\n    //menu.addEvent('onUpdateCommit',commit.updateInventory.bind(commit));\r\n\r\n    return menu;\r\n};\r\n\r\nEngine.getIngredientsPanel = function(){\r\n    return Engine.menus['crafting'].panels['ingredients'];\r\n};\r\n\r\nEngine.addHero = function(data){\r\n    // data comes from the initTrim()'ed packet of the player\r\n    Engine.player = new Hero();\r\n    Engine.player.setUp(data);\r\n    Engine.camera.startFollow(Engine.player); // leave outside of constructor\r\n    //Engine.camera.setDeadzone(7*32,5*32);\r\n    Engine.camera.setLerp(0.1);\r\n    /*var graphics = Engine.scene.add.graphics().setScrollFactor(0);\r\n    // graphics.lineStyle(2, 0x00ff00, 1);\r\n    var w = Engine.camera.deadzone.width;\r\n    var h = Engine.camera.deadzone.height;\r\n    graphics.strokeRect(Engine.camera.centerX-(w/2), Engine.camera.centerY-(h/2), w, h);\r\n    graphics.setDepth(2000);*/\r\n};\r\n\r\nEngine.updateEnvironment = function(){\r\n    if(!Engine.playerIsInitialized) return;\r\n    var chunks = Utils.listAdjacentAOIs(Engine.player.chunk);\r\n    var newChunks = chunks.diff(Engine.displayedChunks);\r\n    var oldChunks = Engine.displayedChunks.diff(chunks);\r\n\r\n    if(!_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) {\r\n        for (var i = 0; i < oldChunks.length; i++) {\r\n            Engine.removeChunk(oldChunks[i]);\r\n        }\r\n    }\r\n\r\n    for(var j = 0; j < newChunks.length; j++){\r\n        Engine.displayChunk(newChunks[j]);\r\n    }\r\n};\r\n\r\nEngine.displayChunk = function(id){\r\n    if(Engine.mapDataCache[id]){\r\n        // Chunks are deleted and redrawn rather than having their visibility toggled on/off, to avoid accumulating in memory\r\n        Engine.drawChunk(Engine.mapDataCache[id],id);\r\n    }else {\r\n        Engine.loadJSON(Engine.mapDataLocation+'/chunk' + id + '.json', Engine.drawChunk, id);\r\n    }\r\n};\r\n\r\nEngine.loadJSON = function(path,callback,data){\r\n    var xobj = new XMLHttpRequest();\r\n    xobj.overrideMimeType(\"application/json\");\r\n    xobj.open('GET', path, true);\r\n    xobj.onreadystatechange = function () {\r\n        if (xobj.readyState == 4 && xobj.status == \"200\") {\r\n            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode\r\n            callback(JSON.parse(xobj.responseText),data);\r\n        }\r\n    };\r\n    xobj.send(null);\r\n};\r\n\r\nEngine.drawChunk = function(mapData,id){\r\n    var chunk = new Chunk(mapData, id, 1);\r\n    Engine.chunks[chunk.id] = chunk;\r\n    if (!Engine.mapDataCache[chunk.id]) Engine.mapDataCache[chunk.id] = mapData;\r\n    Engine.displayedChunks.push(chunk.id);\r\n    Engine.updateBehindness();\r\n};\r\n\r\nEngine.removeChunk = function(id){\r\n    if(Engine.useBlitters) return; // todo: hack\r\n    Engine.chunks[id].erase();\r\n    Engine.displayedChunks.splice(Engine.displayedChunks.indexOf(id),1);\r\n};\r\n\r\n// Check if a non-walkable tile is at a given position or not\r\nEngine.checkCollision = function(x,y){ // returns true if tile is not walkable\r\n    return Engine.collisions.has(x,y);\r\n};\r\n\r\nEngine.checkResource = function(x,y){\r\n    return Engine.resources.has(x,y);\r\n};\r\n\r\nEngine.handleKeyboard = function(event){\r\n    //console.log(event);\r\n    if(Engine.currentTutorialPanel && Engine.currentTutorialPanel.handleKeyboard){\r\n        Engine.currentTutorialPanel.handleKeyboard(event);\r\n        return;\r\n    }\r\n    if(event.key == 'Enter') Engine.toggleChatBar();\r\n};\r\n\r\nEngine.handleDown = function(pointer,objects){\r\n    UI.downCursor();\r\n    if(objects.length > 0 && objects[0].handleDown)objects[0].handleDown(pointer);\r\n};\r\n\r\nEngine.handleClick = function(pointer,objects){\r\n    UI.upCursor();\r\n    if(objects.length > 0){\r\n        for(var i = 0; i < Math.min(objects.length,2); i++){ // disallow bubbling too deep, only useful in menus (i.e. shallow)\r\n            if(objects[i].handleClick) objects[i].handleClick(pointer);\r\n        }\r\n    }else{\r\n        if(!BattleManager.inBattle && !Engine.dead) {\r\n            if(Engine.bldRect){\r\n                Engine.bldUnclick();\r\n            }else {\r\n                if(Engine.inMenu && !Engine.currentMenu.allowWalk) return;\r\n                Engine.moveToClick(pointer);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nEngine.handleOver = function(pointer,objects){\r\n    if(pointer.x == 0 && pointer.y == 0) return; // quick fix\r\n    if(objects.length > 0){\r\n        for(var i = 0; i < Math.min(objects.length,2); i++) { // disallow bubbling too deep, only useful in menus (i.e. shallow)\r\n            var obj = objects[i];\r\n            if(obj.constructor.name == 'Building') Engine.hideMarker();\r\n            if(obj.handleOver) obj.handleOver();\r\n        }\r\n    }\r\n};\r\n\r\nEngine.handleOut = function(pointer,objects){\r\n    if(objects.length > 0) {\r\n        for(var i = 0; i < Math.min(objects.length,2); i++) { // disallow bubbling too deep, only useful in menus (i.e. shallow)\r\n            var obj = objects[i];\r\n            if(obj.constructor.name == 'Building' && (!Engine.inMenu || Engine.currentMenu.allowWalk)) Engine.showMarker();\r\n            if(obj.handleOut) obj.handleOut();\r\n        }\r\n    }\r\n};\r\n\r\nEngine.handleDrag = function(pointer,object,dragX,dragY){\r\n    if(object && object.handleDrag) object.handleDrag(dragX,dragY);\r\n};\r\n\r\nEngine.moveToClick = function(pointer){\r\n    Engine.player.setDestinationAction(0);\r\n    Engine.computePath(Engine.getMouseCoordinates(pointer).tile,false);\r\n};\r\n\r\nEngine.computePath = function(position,nextTo){\r\n    // console.log('going to ',position);\r\n    var x = position.x;\r\n    var y = position.y;\r\n    if(x === undefined || y === undefined) console.warn('Pathfiding to undefined coordinates');\r\n    // if(!nextTo && Engine.checkCollision(x,y)) return;\r\n    var start = Engine.player.getPFstart();\r\n    if(Engine.player.moving) Engine.player.stop();\r\n\r\n    var path = Engine.pathFinder.findPath(start,{x:x,y:y},false,nextTo); // seek = false, nextTo = true\r\n    if(!path) {\r\n        if(!Engine.checkCollision(x,y)) Engine.player.talk('It\\'s too far!');\r\n        // Engine.player.talk('I can\\'t go there!');\r\n        return;\r\n    }\r\n\r\n    var trim = PFUtils.trimPath(path,Engine.battleCellsMap);\r\n    if(trim.trimmed) Engine.player.setDestinationAction(0);\r\n    path = trim.path;\r\n\r\n    if(Engine.player.destinationAction && Engine.player.destinationAction.type != 1) path.pop();\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].sendPath(path,Engine.player.destinationAction);\r\n    Engine.player.queuePath(path);\r\n};\r\n\r\nEngine.updatePosition = function(player){\r\n    if(player.x > player.previousPosition.x){ // right\r\n        player.orientation = 'right';\r\n    }else if(player.x < player.previousPosition.x) { // left\r\n        player.orientation = 'left';\r\n    }else if(player.y > player.previousPosition.y) { // down\r\n        player.orientation = 'down';\r\n    }else if(player.y < player.previousPosition.y) { // up\r\n        player.orientation = 'up';\r\n    }\r\n\r\n    player.previousPosition = {\r\n        x: player.x,\r\n        y: player.y\r\n    };\r\n    player.tileX = Math.floor(player.x/Engine.tileWidth);\r\n    player.tileY = Math.floor(player.y/Engine.tileHeight);\r\n    if(player.id == Engine.player.id) {\r\n        player.chunk = Utils.tileToAOI({x: player.tileX, y: player.tileY});\r\n        if (player.chunk != player.previousChunk) Engine.updateEnvironment();\r\n        player.previousChunk = player.chunk;\r\n    }\r\n};\r\n\r\nEngine.getMouseCoordinates = function(pointer){\r\n    // +16 so that the target tile is below the middle of the cursor\r\n    var pxX = Engine.camera.scrollX + pointer.x;// + 16;\r\n    var pxY = Engine.camera.scrollY + pointer.y;// + 16;\r\n    if(!Engine.debugMarker && !BattleManager.inBattle){\r\n        pxX += 16;\r\n        pxY += 16;\r\n    }\r\n    var tileX = Math.floor(pxX/Engine.tileWidth);\r\n    var tileY = Math.floor(pxY/Engine.tileHeight);\r\n    Engine.lastPointer = {x:pointer.x,y:pointer.y};\r\n    return {\r\n        tile:{x:tileX,y:tileY},\r\n        pixel:{x:pxX,y:pxY}\r\n    };\r\n};\r\n\r\nEngine.isInView = function(x,y){\r\n    if(x < Engine.player.tileX - VIEW_WIDTH/2) return false;\r\n    if(x >= Engine.player.tileX + VIEW_WIDTH/2) return false;\r\n    if(y < Engine.player.tileY - VIEW_HEIGHT/2) return false;\r\n    if(y >= Engine.player.tileY + VIEW_HEIGHT/2) return false;\r\n    return true;\r\n};\r\n\r\nEngine.trackMouse = function(event){\r\n    var position = Engine.getMouseCoordinates(event);\r\n    if(Engine.player) Engine.updateMarker(position.tile);\r\n    if(Engine.debug){\r\n        document.getElementById('pxx').innerHTML = Math.round(event.x);\r\n        document.getElementById('pxy').innerHTML = Math.round(event.y);\r\n        document.getElementById('tx').innerHTML = position.tile.x;\r\n        document.getElementById('ty').innerHTML = position.tile.y;\r\n        document.getElementById('aoi').innerHTML = Utils.tileToAOI(position.tile);\r\n    }\r\n};\r\n\r\nEngine.updateMarker = function(tile){\r\n    Engine.marker.x = (tile.x*Engine.tileWidth);\r\n    Engine.marker.y = (tile.y*Engine.tileHeight);\r\n    if(Engine.bldRect) Engine.updateBldRect();\r\n    if(tile.x != Engine.marker.previousTile.x || tile.y != Engine.marker.previousTile.y){\r\n        Engine.marker.previousTile = tile;\r\n        if(Engine.checkCollision(tile.x,tile.y)){\r\n            if(Engine.debugMarker) Engine.marker.setFrame(1);\r\n        }else{\r\n            if(Engine.debugMarker) Engine.marker.setFrame(0);\r\n        }\r\n    }\r\n};\r\n\r\nEngine.hideMarker = function(){\r\n    if(Engine.marker) Engine.marker.setVisible(false);\r\n};\r\n\r\nEngine.showMarker = function(){\r\n    if(Engine.debugMarker && Engine.marker) Engine.marker.setVisible(true);\r\n};\r\n\r\n/*\r\n* #### UPDATE CODE #####\r\n* */\r\n\r\nEngine.updateSelf = function(data){\r\n    Engine.player.updateData(data);\r\n};\r\n\r\nEngine.update = function(){\r\n\r\n};\r\n\r\nEngine.getAnimalData = function(type){\r\n    var animalData = Engine.animalsData[type];\r\n    if(!animalData){\r\n        console.warn('ERROR: no animal data for animal',type);\r\n        return {};\r\n    }\r\n    if(animalData.inheritFrom !== undefined) animalData = Object.assign(Engine.animalsData[animalData.inheritFrom],animalData);\r\n    return animalData;\r\n};\r\n\r\n// Processes the global update packages received from the server\r\nEngine.updateWorld = function(data){  // data is the update package from the server\r\n    //console.log(data);\r\n    // TODO: store client/server-shared list somewhere\r\n    var entities = ['animal','building','cell','civ','item','player','remain'];\r\n\r\n    entities.forEach(function(e){\r\n        var news = data['new'+e+'s'];\r\n        var edits = data[e+'s'];\r\n        var dels = data['removed'+e+'s'];\r\n        if(news) Engine.createElements(news,e);\r\n        if(edits) Engine.updateElements(edits,Engine[e+'s']);\r\n        if(dels) Engine.removeElements(dels,(e == 'cell' ? Engine.battleCells : Engine[e+'s'])); // quick fix\r\n    });\r\n};\r\n\r\nEngine.createElements = function(arr,entityType){ // entityType = 'animal', 'building', ...\r\n    var pool = Engine.entityManager.pools[entityType];\r\n    var constructor = Engine.entityManager.constructors[entityType];\r\n    arr.forEach(function(data){\r\n        var e = pool.length > 0 ? pool.shift() : new constructor();\r\n        e.setUp(data);\r\n        e.update(data);\r\n        if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) TutorialManager.triggerHook('new'+entityType+':'+data.type);\r\n    });\r\n};\r\n\r\n// For each element in obj, call update()\r\n// format: list of {id,data}\r\nEngine.updateElements = function(obj,table){\r\n    Object.keys(obj).forEach(function (key) {\r\n        if(!table.hasOwnProperty(key)) {\r\n            // if(Engine.debug) console.warn('Attempt to update non-existing element with ID',key);\r\n            return;\r\n        }\r\n        table[key].update(obj[key]);\r\n    });\r\n};\r\n\r\nEngine.removeElements = function(arr,table){\r\n    arr.forEach(function(id){\r\n        if(!table.hasOwnProperty(id)) {\r\n            // if(Engine.debug) console.warn('Attempt to remove non-existing element with ID',id);\r\n            return;\r\n        }\r\n        table[id].remove();\r\n    });\r\n};\r\n\r\nEngine.updateMenus = function(category){\r\n    var callbackMap = {\r\n        'belt': 'onUpdateBelt',\r\n        'bldrecipes': 'onUpdateBuildRecipes',\r\n        'character': 'onUpdateCharacter',\r\n        'citizen': 'onUpdateCitizen',\r\n        'commit': 'onUpdateCommit',\r\n        'equip': 'onUpdateEquipment',\r\n        'gold': 'onUpdateGold',\r\n        'history': 'onUpdateHistory',\r\n        'inv': 'onUpdateInventory',\r\n        'map': 'onUpdateMap',\r\n        'productivity':'onUpdateProductivity',\r\n        'stats': 'onUpdateStats'\r\n    };\r\n\r\n    var event = callbackMap[category];\r\n    if(Engine.currentMenu) Engine.currentMenu.trigger(event);\r\n\r\n    var capsulesMap = {\r\n        // 'food': Engine.foodCapsule,\r\n        'gold': Engine.goldCapsule,\r\n        'inv': Engine.bagCapsule,\r\n        'stats': Engine.capsules,\r\n        // 'vigor': Engine.vigorCapsule\r\n    };\r\n    if(category in capsulesMap) capsulesMap[category].update();\r\n};\r\n\r\nEngine.inThatBuilding = function(id){\r\n    return (Engine.currentBuiling && Engine.currentBuiling.id == id);\r\n};\r\n\r\nEngine.checkForBuildingMenuUpdate= function(id,event){\r\n    if(Engine.inThatBuilding(id)) {\r\n        Engine.currentMenu.trigger(event);\r\n    }\r\n    if(Engine.repairPanel.displayed) Engine.repairPanel.update();\r\n};\r\n\r\nEngine.addPlayer = function(data){\r\n    var sprite = new Player();\r\n    sprite.setUp(data);\r\n    return sprite;\r\n};\r\n\r\nEngine.getTilesetFromTile = function(tile){\r\n    if(Engine.tilesetMap.hasOwnProperty(tile)) return Engine.tile\r\n    setMap[tile];\r\n    for(var i = 0; i < Engine.tilesets.length; i++){\r\n        if(tile < Engine.tilesets[i].firstgid){\r\n            Engine.tilesetMap[tile] = i-1;\r\n            return i-1;\r\n        }\r\n    }\r\n    return Engine.tilesets.length-1;\r\n};\r\n\r\nEngine.enterBuilding = function(id){\r\n    if(id == -1) return;\r\n    Engine.player.setVisible(false);\r\n    var building = Engine.buildings[id];\r\n    Engine.inBuilding = true;\r\n    Engine.currentBuiling = building; // used to keep track of which building is displayed in menus\r\n    var buildingData = Engine.buildingsData[building.buildingType];\r\n\r\n    var mainMenu;\r\n    if(building.built == true) {\r\n        mainMenu = Engine.menus[buildingData.mainMenu];\r\n    }else{\r\n        mainMenu = Engine.menus.construction;\r\n    }\r\n\r\n    mainMenu.display();\r\n    building.handleOut();\r\n\r\n    Engine.buildingTitle.setText(buildingData.name);\r\n    var owner = Engine.currentBuiling.isOwned() ? 'Your' : (Engine.currentBuiling.ownerName || 'Player')+'\\'s';\r\n    Engine.buildingTitle.capsule.setText(owner);\r\n    Engine.buildingTitle.move(Engine.currentMenu.titleY);\r\n    Engine.buildingTitle.display();\r\n\r\n    if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) TutorialManager.checkHook();\r\n};\r\n\r\nEngine.exitBuilding = function(){\r\n    Engine.player.setVisible(true);\r\n    Engine.camera.startFollow(Engine.player);\r\n    Engine.inBuilding = false;\r\n    Engine.currentBuiling = null;\r\n    Engine.currentMenu.hide();\r\n    Engine.buildingTitle.hide();\r\n    for(var m in Engine.menus){\r\n        if(!Engine.menus.hasOwnProperty(m)) continue;\r\n        Engine.menus[m].hideIcon();\r\n    }\r\n    if(Engine.miniMap)  Engine.miniMap.follow();\r\n    if(_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial) TutorialManager.triggerHook('exit');\r\n};\r\n\r\nEngine.getHolderSize = function(){\r\n    return (Engine.countIcons()-1)*50 + 15;\r\n};\r\n\r\nEngine.countIcons = function(){\r\n    var count = 0;\r\n    Engine.UIelements.forEach(function(e){\r\n        if(e.visible) count++;\r\n    });\r\n    return count;\r\n};\r\n\r\nEngine.processNPCClick = function(target){\r\n    if(Engine.inPanel) return;\r\n    if(target.dead){\r\n        var action = target.entityType == 'animal' ? 2 : 4;\r\n        Engine.player.setDestinationAction(action,target.id,target.tileX,target.tileY); // 2 for NPC\r\n        Engine.computePath({x:target.tileX,y:target.tileY});\r\n    }else{\r\n        _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].NPCClick(target.id,(target.entityType == 'animal' ? 0 : 1));\r\n    }\r\n};\r\n\r\nEngine.processItemClick = function(target){\r\n    if(Engine.inPanel) return;\r\n    Engine.player.setDestinationAction(3,target.id,target.tileX,target.tileY); // 3 for item\r\n    Engine.computePath({x:target.tileX,y:target.tileY},true);\r\n};\r\n\r\nEngine.requestBattleAttack = function(target){\r\n    if(BattleManager.actionTaken) return;\r\n    Engine.requestBattleAction('attack',{id:target.getShortID()});\r\n};\r\n\r\nEngine.requestBomb = function(x,y){\r\n    if(BattleManager.actionTaken) return;\r\n    Engine.requestBattleAction('bomb',{x:x,y:y});\r\n};\r\n\r\n// General battle action method called by the more specific ones (except moving)\r\nEngine.requestBattleAction = function(action,data){\r\n    BattleManager.actionTaken = true;\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].battleAction(action,data);\r\n};\r\n\r\n/*Engine.getGridFrame = function(x,y){\r\n    var grid = Engine.battleZones;\r\n    var hasleft = grid.has(x-1,y);\r\n    var hasright = grid.has(parseInt(x)+1,y);\r\n    var hastop = grid.has(x,y-1);\r\n    var hasbottom = grid.has(x,parseInt(y)+1);\r\n    var row, col;\r\n\r\n    if(hastop && !hasbottom){\r\n        row = 2;\r\n    }else if(!hastop && hasbottom){\r\n        row = 0;\r\n    }else{\r\n        row = 1;\r\n    }\r\n\r\n    if(hasleft && !hasright){\r\n        col = 2\r\n    }else if(!hasleft && hasright){\r\n        col = 0;\r\n    }else{\r\n        col = 1;\r\n    }\r\n\r\n    //console.log(x,y,col,row,hasleft,hasright,hastop,hasbottom);\r\n    return Utils.gridToLine(col,row,3);\r\n};*/\r\n\r\nEngine.isBattleCell = function(x,y){\r\n    return Engine.battleCells.get(x,y);\r\n};\r\n\r\nEngine.getNextPrint = function(){\r\n    if(Engine.printsPool.length > 0) return Engine.printsPool.shift();\r\n    return Engine.scene.add.image(0,0,'footsteps');\r\n};\r\n\r\nEngine.recycleSprite = function(sprite){\r\n    Engine.spritePool.recycle(sprite);\r\n};\r\n\r\nEngine.recycleImage = function(image){\r\n    Engine.imagePool.recycle(image);\r\n};\r\n\r\nEngine.recyclePrint = function(print){\r\n    Engine.printsPool.push(print);\r\n};\r\n\r\nEngine.updateGrid = function(){\r\n    Engine.entityManager.displayLists['cell'].forEach(function(id){\r\n        Engine.battleCells[id].update();\r\n    });\r\n};\r\n\r\nEngine.getOccupiedCells = function(entity,hash){\r\n    if(entity.entityType == 'building') return [];\r\n    var cells = [];\r\n    for(var i = 0; i < entity.cellsWidth; i++){\r\n        for(var j = 0; j < entity.cellsHeight; j++){\r\n            if(hash){\r\n                cells.push((entity.tileX+i)+'_'+(entity.tileY+j));\r\n            }else{\r\n                cells.push({x:entity.tileX,y:entity.tileY});\r\n            }\r\n        }\r\n    }\r\n    return cells;\r\n};\r\n\r\n// ## UI-related functions ##\r\n// this functions need to have a this bound to them\r\nEngine.closePanel = function(){this.hide();};\r\nEngine.togglePanel = function(){ // When clicking on a player/building/animal, toggle the corresponding panel visibility\r\n    if(Engine.inMenu) return;\r\n    if(this.panel.displayed){\r\n        Engine.inPanel = false;\r\n        Engine.currentPanel = null;\r\n    }else {\r\n        if(Engine.inPanel) Engine.currentPanel.hide();\r\n        Engine.inPanel = true;\r\n        Engine.currentPanel = this.panel;\r\n    }\r\n    this.panel.toggle();\r\n};\r\n\r\nEngine.recipeClick = function(){\r\n    Engine.menus['crafting'].panels['combi'].setUp(this.itemID);\r\n    var sound = Engine.itemsData[this.itemID].sound;\r\n    if(sound) Engine.scene.sound.add(sound).play();\r\n};\r\n\r\nEngine.toggleStock = function(stockID){\r\n    Engine.craftingStock = stockID;\r\n    if(stockID == 1){\r\n        Engine.currentMenu.panels['stock'].button.display();\r\n        Engine.currentMenu.panels['items'].button.hide();\r\n        Engine.currentMenu.panels['ingredients'].modifyReferenceInventory(Engine.player.inventory);\r\n    }else{\r\n        Engine.currentMenu.panels['items'].button.display();\r\n        Engine.currentMenu.panels['stock'].button.hide();\r\n        Engine.currentMenu.panels['ingredients'].modifyReferenceInventory(Engine.currentBuiling.inventory);\r\n    }\r\n    Engine.currentMenu.panels['ingredients'].updateInventory();\r\n    Engine.currentMenu.panels['combi'].manageButtons();\r\n};\r\n\r\nEngine.newbuildingClick = function(){\r\n    Engine.currentMenu.panels['confirm'].setUp(this.itemID);\r\n};\r\n\r\n/**\r\n * What to do when clicked an item in belt (vs. backpack).\r\n * `this` is bound to the clicked `ItemSperite`.\r\n */\r\nEngine.beltClick = function(){\r\n    Engine.displayItemActionPanel(this.itemID, 'belt');\r\n};\r\n\r\n/**\r\n * What to do when clicked an item in backpack (vs. belt).\r\n * `this` is bound to the clicked `ItemSperite`.\r\n */\r\nEngine.backpackClick = function(){\r\n    Engine.displayItemActionPanel(this.itemID, 'backpack');\r\n};\r\n\r\n/**\r\n * Display the itemAction window, i.e. the small panel appearing in the inventory \r\n * displaying options such as use, put in belt...\r\n * @param {number} itemID - ID of the clicked item.\r\n * @param {string} inventory - Whether the item was clicked in the backpack or in the belt.\r\n */\r\nEngine.displayItemActionPanel = function(itemID, inventory){\r\n    Engine.currentMenu.panels['itemAction'].display();\r\n    Engine.currentMenu.panels['itemAction'].setUp(itemID, inventory);\r\n};\r\n\r\n\r\n// Engine.inventoryClick = function(){\r\n//     if(BattleManager.inBattle) {\r\n//         var sticky = Engine.itemsData[this.itemID].stickMouse;\r\n//         UI.manageCursor(+sticky,'sticky');\r\n//         if(sticky){\r\n//             Engine.stickyCursor = true;\r\n//             return false;\r\n//         }else {\r\n//             Client.sendUse(this.itemID,'belt');\r\n//             return true;\r\n//         }\r\n//     }else{\r\n//         // itemAction is the small panel appearing in the inventory displaying options such as use, throw...\r\n//         Engine.currentMenu.panels['itemAction'].display();\r\n//         Engine.currentMenu.panels['itemAction'].setUp(this.itemID);\r\n//     }\r\n// };\r\n\r\nEngine.unequipClick = function(){ // Sent when unequipping something\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].sendUnequip(this.slotName);\r\n};\r\n\r\nEngine.sellClick = function(){\r\n    Engine.currentMenu.panels['action'].setUp(this.itemID,'sell');\r\n    /*if(Engine.currentBuiling.isOwned()){\r\n        Engine.currentMenu.panels['prices'].display();\r\n    }*/\r\n};\r\n\r\nEngine.buyClick = function(){\r\n    Engine.currentMenu.panels['action'].setUp(this.itemID,'buy');\r\n    /*if(Engine.currentBuiling.isOwned()){\r\n        Engine.currentMenu.panels['prices'].display();\r\n    }*/\r\n};\r\n\r\nEngine.giveClick = function(itemID){\r\n    Engine.currentMenu.panels['action'].display();\r\n    Engine.currentMenu.panels['action'].setUp(itemID,'sell');\r\n};\r\n\r\nEngine.takeClick = function(){\r\n    //if(Engine.currentBuiling.owner != Engine.player.id) return;\r\n    if(!Engine.currentBuiling.isOwned()) return;\r\n    Engine.currentMenu.panels['action'].display();\r\n    Engine.currentMenu.panels['action'].setUp(this.itemID,'buy');\r\n};\r\n\r\nEngine.respawnClick = function(){ // this bound to respawn panel\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].sendRespawn();\r\n    Engine.menus[\"respawn\"].hide();\r\n};\r\n\r\nEngine.buildError = function(){\r\n    Engine.currentMenu.panels['confirm'].displayError();\r\n};\r\n\r\nEngine.buildSuccess = function(){\r\n    Engine.currentMenu.panels['buildings'].hide();\r\n    Engine.currentMenu.panels['confirm'].hide();\r\n    Engine.currentMenu.panels['ingredients'].hide();\r\n    Engine.currentMenu.panels['map'].map.hideRedPin();\r\n};\r\n\r\nEngine.leaveBuilding = function(){\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].sendExit();\r\n    Engine.exitBuilding();\r\n};\r\n\r\nEngine.snap = function(){\r\n    game.renderer.snapshot(function(img){\r\n        _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].sendScreenshot(img.src,detectBrowser());\r\n    });\r\n};\r\n\r\nEngine.debugQT = function(quads){\r\n    Engine.qtQuads.forEach(function(q){\r\n       q.destroy();\r\n    });\r\n    quads.forEach(function(q){\r\n        var rect = Engine.scene.add.rectangle(q.x*32, q.y*32, (q.w)*32, (q.h)*32, 0x6666ff);\r\n        rect.setDepth(100).setOrigin(0);\r\n        Engine.qtQuads.push(rect);\r\n    });\r\n};\r\n\r\nfunction cl(){\r\n    localStorage.clear();\r\n}\r\n\r\nfunction s(){\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].socket.emit('ss');\r\n}\r\n\r\nfunction test(){\r\n    var rt = UI.scene.add.renderTexture(400, 300, 300, 300);\r\n    rt.draw(Engine.buildings[0],10,10);\r\n    rt.setDepth(100);\r\n    rt.setScrollFactor(0);\r\n    console.log('ok');\r\n}\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (Engine);\n\n//# sourceURL=webpack:///./client/Engine.js?");

/***/ }),

/***/ "./client/Tooltip.js":
/*!***************************!*\
  !*** ./client/Tooltip.js ***!
  \***************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _UI__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./UI */ \"./client/UI.js\");\n/**\r\n * Created by Jerome on 29-11-17.\r\n */\r\n\r\n\r\n\r\nvar Tooltip = new Phaser.Class({\r\n\r\n    Extends: Phaser.GameObjects. DOMElement,\r\n\r\n    initialize: function Tooltip(){\r\n        Phaser.GameObjects.DOMElement.call(this, _UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scene, 0, 0);\r\n        _UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scene.add.displayList.add(this);\r\n\r\n        this.createFromCache('tooltip');\r\n        this.title = this.getChildByID('tooltip_title');\r\n        this.body = this.getChildByID('tooltip_body');\r\n        this.stat_table = this.getChildByID('stat');\r\n        this.base_stat = this.getChildByID('base');\r\n        this.fatigue_modifier = this.getChildByID('fatigue_modifier');\r\n        this.equipment_modifier = this.getChildByID('equipment_modifier');\r\n        this.effects = this.getChildByID('effects');\r\n        this.effect_icon = this.getChildByID('effect_icon');\r\n        this.effect_nb = this.getChildByID('effect_nb');\r\n        this.owned = this.getChildByID('owned');\r\n        this.owned_icon = this.getChildByID('owned_icon');\r\n        this.owned_nb = this.getChildByID('owned_nb');\r\n        this.bar = this.getChildByID('bar');\r\n        this.lifebar = this.getChildByID('lifebar');\r\n\r\n        this.setOrigin(0);\r\n        this.setScrollFactor(0);\r\n        this.hide();\r\n    },\r\n\r\n    updatePosition: function(x,y){\r\n        this.setPosition(\r\n            x + 25,\r\n            y + 25\r\n        );\r\n        if(this.x + this.computeWidth() > _UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].getGameWidth()) this.x -= (this.computeWidth() + 30);\r\n        if(this.y + this.computeHeight() > _UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].getGameHeight()) this.y -= (this.computeHeight() + 30);\r\n    },\r\n\r\n    updateInfo: function(type,data){\r\n        this.clear();\r\n        switch(type){\r\n            case 'building':\r\n                var bld = Engine.buildings[data.id];\r\n                var owner = bld.isOwned() ? 'Your' : bld.ownerName+'\\'s';\r\n                if(bld.civBuilding) owner = 'Enemy';\r\n                this.setTitle(owner+' '+bld.name);\r\n                if(bld.isBuilt()) this.setBar(bld.stats['hp'].getValue(),bld.stats['hpmax'].getValue());\r\n                break;\r\n            case 'buildingdata':\r\n                var bld = Engine.buildingsData[data.id];\r\n                this.setTitle(bld.name);\r\n                this.setBody(bld.desc);\r\n                break;\r\n            case 'free':\r\n                if(data.title) this.setTitle(data.title);\r\n                if(data.body) this.setBody(data.body);\r\n                break;\r\n            case 'pickupItem':\r\n                if(data.id == -1) break;\r\n                this.setNbOwned(Engine.itemsData[data.id].effects, Engine.player.getItemNb(data.id));\r\n                // fall through\r\n            case 'item':\r\n                if(data.id == -1) break;\r\n                var item = Engine.itemsData[data.id];\r\n                this.setTitle(item.name ? item.name : '');\r\n                this.setBody(item.desc ? item.desc : '');\r\n                if(item.effects) this.setEffects(item.effects);\r\n                break;\r\n            case 'NPC':\r\n                var npc = data.type == 'civ' ? Engine.civs[data.id] : Engine.animals[data.id];\r\n                var name = (npc.isDead() ? 'Dead ' : '')+npc.name;\r\n                this.setTitle(name);\r\n                break;\r\n            case 'slot':\r\n                var slot = Equipment.slots[data.slot];\r\n                this.setTitle(slot.name);\r\n                this.setBody(slot.desc);\r\n                break;\r\n            case 'stat':\r\n                var stat = Stats[data.stat];\r\n                this.setTitle(stat.name);\r\n                this.setBody(stat.desc);\r\n                this.setStat(data.stat);\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    },\r\n\r\n    clear: function(){\r\n        this.setTitle('');\r\n        this.setBody('');\r\n        this.effects.style.display = 'none';\r\n        this.owned.style.display = 'none';\r\n        this.stat_table.style.display = 'none';\r\n        this.bar.style.display = 'none';\r\n    },\r\n\r\n    setTitle: function(text){\r\n        this.title.innerText = text;\r\n    },\r\n\r\n    setBody: function(text){\r\n        this.body.innerText = text;\r\n    },\r\n\r\n    setStat: function(stat){\r\n        var statData = Engine.player.getStat(stat);\r\n        this.base_stat.innerText = '= '+statData.getBaseValue(stat);\r\n        var eq = statData.absoluteModifiers[0];\r\n        var fatigue = statData.relativeModifiers[0];\r\n        if(eq || fatigue) {\r\n            this.stat_table.style.display = 'inline';\r\n            if (eq) this.equipment_modifier.innerText = '+' + eq + ' (equipment)';\r\n            if (fatigue) this.fatigue_modifier.innerText = fatigue + '% (vigor)';\r\n            this.equipment_modifier.style.display = (eq ? 'inline' : 'none');\r\n            this.fatigue_modifier.style.display = (fatigue ? 'inline' : 'none');\r\n        }\r\n    },\r\n\r\n    setEffects: function(effects){\r\n        for(var effect in effects) {\r\n            this.effects.style.display = 'block';\r\n            var frame = _UI__WEBPACK_IMPORTED_MODULE_0__[\"default\"].statsFrames[Stats[effect].frame];\r\n            this.effect_icon.style.backgroundPosition = '-' + frame.x + 'px -' + frame.y + 'px';\r\n            this.effect_nb.innerHTML = '+'+effects[effect];\r\n        }\r\n    },\r\n\r\n    setNbOwned: function(effects, nb){\r\n        this.owned.style.display = 'block';\r\n        // this.owned_icon.style.marginLeft = (effects ? '-16' : '0')+'px';\r\n        this.owned_nb.innerHTML = nb;\r\n    },\r\n\r\n    setBar: function(value,max){\r\n        this.bar.style.display = 'block';\r\n        this.lifebar.style.width = (value*100/max)+'%';\r\n        // this.lifebar.style.width = '10%';\r\n        // this.lifebar.innerHTML = value+'/'+max;\r\n        // console.warn(value,max,value/max);\r\n        // console.warn(this.lifebar.style.width);\r\n    },\r\n\r\n    getBodyText: function(){\r\n        return this.body.innerText;\r\n    },\r\n\r\n    getTitleText: function(){\r\n        return this.title.innerText;\r\n    },\r\n\r\n    computeWidth: function(){\r\n        return Math.max(\r\n            Math.min(this.getBodyText().length,40) * 6.5,\r\n            this.getTitleText().length * 8\r\n        );\r\n    },\r\n\r\n    computeHeight: function(){\r\n        return (Math.ceil(this.getBodyText().length/40) * 15)+40;\r\n    },\r\n\r\n    display: function(){\r\n        this.setVisible(true);\r\n        this.displayed = true;\r\n    },\r\n\r\n    hide: function(){\r\n        this.setVisible(false);\r\n        this.displayed = false;\r\n    }\r\n});\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (Tooltip);\n\n//# sourceURL=webpack:///./client/Tooltip.js?");

/***/ }),

/***/ "./client/UI.js":
/*!**********************!*\
  !*** ./client/UI.js ***!
  \**********************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _Boot__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Boot */ \"./client/Boot.js\");\n/* harmony import */ var _Client__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Client */ \"./client/Client.js\");\n/* harmony import */ var _shared_Stats__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../shared/Stats */ \"./shared/Stats.js\");\n/* harmony import */ var _Tooltip__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./Tooltip */ \"./client/Tooltip.js\");\n/* harmony import */ var _UICursor__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./UICursor */ \"./client/UICursor.js\");\n/**\r\n * Created by Jerome Renaux (jerome.renaux@gmail.com) on 14-03-18.\r\n */\r\n\r\n\r\n\r\n\r\n\r\n\r\nvar UI = {\r\n    key: 'UI',\r\n    plugins: ['Clock', 'DataManagerPlugin', 'InputPlugin', 'Loader', 'TweenManager', 'LightsPlugin'],\r\n    tooltipDepth: 20,\r\n\r\n    preload: function () {\r\n        UI.scene = this;\r\n        this.input.setGlobalTopOnly(true); // Prevent clicks from bubbling down to game scene\r\n\r\n        this.load.json('ui-frames', 'assets/sprites/ui.json'); // load frame data separately for use in CSS\r\n        this.load.atlas('UI', 'assets/sprites/ui.png', 'assets/sprites/ui.json');\r\n        this.load.atlas('banners', 'assets/sprites/stlbanner.png', 'assets/sprites/stlbanner.json');\r\n\r\n        this.load.json('texts', 'assets/data/texts.json');\r\n        this.load.json('classes', 'assets/data/classes.json');\r\n        this.load.json('badwords', 'assets/misc/swearWords.json');\r\n\r\n        this.load.audio('click', 'assets/sfx/click.wav');\r\n        this.load.audio('error', 'assets/sfx/error.wav');\r\n\r\n        this.load.html('tooltip', '/assets/html/tooltip.html');\r\n\r\n        this.load.atlas('cursors', 'assets/sprites/cursors.png', 'assets/sprites/cursors.json');\r\n\r\n        if (_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].isNewPlayer()) {\r\n            this.load.image('bigbg', 'assets/sprites/bigbg.png');\r\n            this.load.image('bigbg_mask', 'assets/sprites/bigbg_mask.png');\r\n            this.load.image('worldmap', 'maps/worldmap.png');\r\n            // this.load.image('campdiamond', 'assets/sprites/camp_diamond.png');\r\n            this.load.image('setldiamond', 'assets/sprites/setl_diamond.png');\r\n            this.load.image('wood', 'assets/sprites/wood.jpg');\r\n        }\r\n    },\r\n\r\n    create: function () {\r\n        this.scene.bringToTop();\r\n\r\n        UI.gatherStatsFrames();\r\n        UI.tooltip = new _Tooltip__WEBPACK_IMPORTED_MODULE_3__[\"default\"]();\r\n        UI.camera = UI.scene.cameras.main;\r\n        UI.notifications = [];\r\n        UI.textsData = this.cache.json.get('texts');\r\n        UI.classesData = this.cache.json.get('classes');\r\n\r\n\r\n        UI.scene.sys.game.canvas.style.cursor = 'none';\r\n        UI.cursor = new _UICursor__WEBPACK_IMPORTED_MODULE_4__[\"default\"]();\r\n        UI.setCursor();\r\n\r\n        UI.hovering = [];\r\n        UI.hoverFlower = 0;\r\n\r\n        this.input.setTopOnly(false);\r\n        this.input.on('pointermove', function (event) {\r\n            if (UI.tooltip) UI.tooltip.updatePosition(event.x, event.y);\r\n\r\n            // Add custom cursor sprite to mouse cordinates\r\n            if (UI.cursor) UI.cursor.setPosition(event.x, event.y);\r\n        });\r\n        if (_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].isNewPlayer()) UI.classMenu = UI.makeClassMenu();\r\n\r\n        this.input.keyboard.on('keydown', UI.handleKeyboard);\r\n        this.currentView = 'title';\r\n\r\n        this.scene.get('boot').updateReadyTick();\r\n\r\n        //Auto start game for dev reasons\r\n        if (_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].gameConfig.boot.autoBoot) UI.launchGameMode();\r\n\r\n\r\n    },\r\n\r\n    makeBattleTutorialPanel: function () {\r\n        var h = 200;\r\n        var w = 200;\r\n        var y = UI.getGameHeight() - h;\r\n        var panel = new InfoPanel(0, y, w, h, 'Battle tutorial');\r\n        panel.addText(UI.textsData['battle_help']);\r\n        panel.addBigButton('Got it');\r\n        return panel;\r\n    }\r\n\r\n};\r\n\r\nUI.gatherStatsFrames = function () {\r\n    UI.framesData = UI.scene.cache.json.get('ui-frames');\r\n    var frames = [];\r\n    UI.statsFrames = {};\r\n    for (var stat in _shared_Stats__WEBPACK_IMPORTED_MODULE_2__[\"Stats\"]) {\r\n        var frame = _shared_Stats__WEBPACK_IMPORTED_MODULE_2__[\"Stats\"][stat].frame;\r\n        if (frame) frames.push(frame);\r\n    }\r\n    UI.framesData['frames'].forEach(function (frame) {\r\n        if (frames.includes(frame.filename)) UI.statsFrames[frame.filename] = frame.frame;\r\n    });\r\n};\r\n\r\nUI.handleKeyboard = function (event) {\r\n    //console.log(event);\r\n    if (Engine.playerIsInitialized) {\r\n        if (event.key == 'Enter') Engine.toggleChatBar();\r\n    } else {\r\n        switch (UI.scene.currentView) {\r\n            case 'title':\r\n                if (['Enter', ' '].includes(event.key)) UI.launchGameMode();\r\n                break;\r\n            case 'name':\r\n                if (event.key == 'Enter') UI.validatePlayerName();\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n};\r\n\r\nUI.handleNotifications = function (msgs) {\r\n    if (UI.runningNotifications) {\r\n        setTimeout(UI.handleNotifications, UI.runningNotifications * 10, msgs);\r\n        return;\r\n    }\r\n    // TODO: add to localstorage for display in character panel\r\n    var notifs = [];\r\n    var padding = 10;\r\n    var totalHeight = padding;\r\n    msgs.forEach(function (msg) {\r\n        var notif = new Bubble(0, 0, true); // TODO: use pool (separate speech bubbles from notifs)\r\n        notif.update(msg);\r\n        totalHeight += (notif.getHeight() + padding);\r\n        notifs.push(notif);\r\n    });\r\n    UI.notifications = UI.notifications.filter(function (notif) {\r\n        return notif.displayed;\r\n    });\r\n    UI.notifications.forEach(function (notif) {\r\n        UI.scene.tweens.addCounter({\r\n            from: notif.y,\r\n            to: notif.y - totalHeight,\r\n            duration: 300,\r\n            ease: 'Quad.easeOut',\r\n            onUpdate: function (tween) {\r\n                notif.updatePosition(notif.x, tween.getValue());\r\n            }\r\n        });\r\n    });\r\n    var cumulativeHeight = 0;\r\n    notifs.forEach(function (notif, i) {\r\n        UI.showNotification(notif, i, cumulativeHeight);\r\n        cumulativeHeight += notif.getHeight() + padding;\r\n    });\r\n    //console.log('total time = ',300+(msgs.length-1)*50);\r\n};\r\n\r\nUI.runningNotifications = 0;\r\nUI.showNotification = function (notif, i, height) {\r\n    var x = (UI.getGameWidth() - notif.getWidth()) / 2 - notif.getOrigin();\r\n    var y = UI.getGameHeight();\r\n    notif.updatePosition(x, y);\r\n\r\n    var endy = y - height - 50;\r\n    if (BattleManager.inBattle) endy -= 70;\r\n    notif.endy = endy;\r\n    var tween = UI.scene.tweens.addCounter({\r\n        from: y,\r\n        to: endy,\r\n        duration: 300,\r\n        paused: true,\r\n        ease: 'Quad.easeOut',\r\n        onStart: function () {\r\n            UI.runningNotifications++;\r\n            notif.display();\r\n        },\r\n        onUpdate: function (tween) {\r\n            notif.updatePosition(x, tween.getValue());\r\n        },\r\n        onComplete: function () {\r\n            //console.log('done at ',Date.now());\r\n            UI.runningNotifications--;\r\n        }\r\n    });\r\n\r\n    var delay = i * 50;\r\n    setTimeout(function () {\r\n        tween.play();\r\n    }, delay);\r\n    UI.notifications.push(notif);\r\n};\r\n\r\nUI.getConfig = function () {\r\n    return this.scene.sys.game.config;\r\n};\r\n\r\nUI.getGameWidth = function () {\r\n    return UI.getConfig().width;\r\n};\r\n\r\nUI.getGameHeight = function () {\r\n    return UI.getConfig().height;\r\n};\r\n\r\nUI.manageCursor = function (inout, type, target) {\r\n\r\n    if (target) {\r\n\r\n        if (target.entityType == 'cell' && Engine.cursorOnTarget) return;\r\n\r\n        Engine.cursorOnTarget = (target.entityType != 'cell');\r\n        target.setCursor();\r\n    } else {\r\n        UI.setCursor();\r\n    }\r\n    /*var data = {\r\n        type: type,\r\n        target: target\r\n    };\r\n    var hovering = UI.hovering.last() || {type:'ground'};\r\n\r\n    if(inout == 1){\r\n        if(hovering.type == 'sticky') return; // don't change cursor if currently sticky\r\n        if(type == 'tile' && (hovering.type == 'npc')) return;\r\n        UI.hovering.push(data);\r\n    }else{\r\n        if(type != hovering.type) return;\r\n        UI.hovering.pop();\r\n    }\r\n\r\n    var hovering = UI.hovering.last() || {type:'ground'};\r\n    //console.log('hovering : ',hovering.type);\r\n    if(hovering.type == 'sticky'){\r\n        UI.setCursor('bomb');\r\n    }else if(hovering.type == 'UI'){\r\n        UI.setCursor();\r\n    }else if(hovering.type != 'UI' && hovering.type != 'ground' && hovering.type != 'tile') {\r\n        hovering.target.setCursor();\r\n    }else if(hovering.type == 'tile'){\r\n        //UI.setCursor('move');\r\n        UI.setCursor();\r\n    }else if(hovering.type == 'ground'){\r\n        if(Engine.inMenu){\r\n            UI.setCursor();\r\n        }else {\r\n            UI.setCursor('move');\r\n        }\r\n    }*/\r\n};\r\n\r\nUI.downCursor = function () {\r\n    // if (UI.dualCursors.includes(UI.currentCursor)) UI.setCursor(UI.currentCursor, true);\r\n    UI.cursor.down();\r\n};\r\n\r\nUI.upCursor = function () {\r\n    // UI.setCursor(UI.currentCursor);\r\n    UI.cursor.up();\r\n};\r\n\r\n/**\r\n * Change the appearance of the cursor based on what it's hovering\r\n * @param {string} cursor - key of the frames dict of the cursor to display;\r\n * if nothing, then displays default one\r\n */\r\nUI.setCursor = function (cursor) {\r\n    // var cursorFile = UI.cursors[cursor || 'default'];\r\n    // UI.scene.sys.game.canvas.style.cursor = 'url(/assets/sprites/cursors/'+cursorFile+(down ? '2' : '')+'.png), auto';\r\n    // UI.currentCursor = cursor;\r\n    UI.cursor.changeCursor(cursor);\r\n};\r\n\r\nUI.makeClassMenu = function () {\r\n    var title = new UIHolder(512, 10, 'center');\r\n    title.setText(UI.textsData['class_selection_title']);\r\n\r\n    var menu = new Menu();\r\n    var desch = 60;\r\n    var classw = 400;\r\n    var classh = 195;\r\n    var padding = 20;\r\n    var tlx = 1024 / 2 - classw - padding;\r\n    var y = 80;\r\n    var x = tlx;\r\n    menu.addPanel('title', title);\r\n    var infow = (2 * classw) + padding;\r\n    var info = menu.addPanel('info', new InfoPanel(x, y, infow, desch));\r\n    info.addText(10, 10, UI.textsData['class_selection'], Utils.colors.white, 14, Utils.fonts.normal);\r\n    y += desch + padding;\r\n\r\n    var i = 0;\r\n    for (var classID in UI.classesData) {\r\n        this.makeClassPanel(menu, classID, x, y, classw, classh);\r\n        x += classw + padding;\r\n        if (++i == 2) {\r\n            i = 0;\r\n            x = tlx;\r\n            y += classh + padding;\r\n        }\r\n    }\r\n\r\n    return menu;\r\n};\r\n\r\nUI.makeClassPanel = function (menu, classID, x, y, classw, classh) {\r\n    var classData = UI.classesData[classID];\r\n    var panel = menu.addPanel('class_' + classID, new ClassPanel(x, y, classw, classh, classData.name));\r\n    panel.setClass(classID);\r\n};\r\n\r\nUI.launchGameMode = function () {\r\n    if (UI.gameLaunched) return;\r\n    UI.gameLaunched = true;\r\n    _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].buttons.forEach(function (b) {\r\n        b.hide();\r\n    });\r\n    UI.scene.tweens.add({\r\n        targets: _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].titleBg,\r\n        alpha: 0,\r\n        duration: 1000\r\n    });\r\n    UI.scene.tweens.add({\r\n        targets: _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].title,\r\n        alpha: 0,\r\n        duration: 1000,\r\n        onComplete: function () {\r\n            if (_Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].isNewPlayer()) {\r\n                //UI.displayClassMenu();\r\n                //UI.displaySettlementSelectionMenu();\r\n                UI.displayNameBox();\r\n            } else {\r\n                UI.camera.fadeOut(500);\r\n                UI.camera.once('camerafadeoutcomplete', function () {\r\n                    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial = false;\r\n                    UI.launchGame();\r\n                    UI.camera.fadeIn(500);\r\n                });\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nUI.launchTutorialMode = function () {\r\n    _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].buttons.forEach(function (b) {\r\n        b.hide();\r\n    });\r\n    UI.scene.tweens.add({\r\n        targets: _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].titleBg,\r\n        alpha: 0,\r\n        duration: 1000\r\n    });\r\n    UI.scene.tweens.add({\r\n        targets: _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].title,\r\n        alpha: 0,\r\n        duration: 1000,\r\n        onComplete: function () {\r\n            UI.camera.fadeOut(500);\r\n            UI.camera.once('camerafadeoutcomplete', function () {\r\n                _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].tutorial = true;\r\n                UI.launchGame();\r\n                UI.camera.fadeIn(500);\r\n            });\r\n        }\r\n    });\r\n};\r\n\r\nUI.displayClassMenu = function () {\r\n    UI.classMenu.display();\r\n};\r\n\r\nUI.selectClass = function (id) {\r\n    UI.selectedClass = id;\r\n    UI.camera.fadeOut(500);\r\n    UI.camera.once('camerafadeoutcomplete', function () {\r\n        UI.classMenu.hide();\r\n        _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].background.setVisible(false);\r\n        UI.displaySettlementSelectionMenu();\r\n        UI.camera.fadeIn(500);\r\n    });\r\n};\r\n\r\nUI.displayNameBox = function () {\r\n    UI.scene.currentView = 'name';\r\n    var panel = new NamePanel(362, 150, 300, 140, 'Character name');\r\n    panel.addText(10, 20, 'Enter the name of your character.');\r\n    panel.addBigButton('Next', UI.validatePlayerName);\r\n    panel.display();\r\n    UI.namePanel = panel;\r\n};\r\n\r\nUI.validatePlayerName = function () {\r\n    var badwords = UI.scene.cache.json.get('badwords');\r\n    var name = UI.namePanel.getValue().toLowerCase();\r\n    if (badwords.includes(name)) {\r\n        UI.namePanel.displayError();\r\n    } else {\r\n        UI.displayRegionSelectionMenu();\r\n    }\r\n};\r\n\r\nUI.displayRegionSelectionMenu = function () {\r\n    UI.scene.currentView = 'region';\r\n    if (UI.namePanel) {\r\n        UI.characterName = UI.namePanel.getValue();\r\n        if (!UI.characterName) return;\r\n        UI.namePanel.hide();\r\n    }\r\n    var content = [];\r\n    content.push(UI.scene.add.image(0, 0, 'wood').setOrigin(0));\r\n    var scroll = UI.scene.add.image(UI.getGameWidth() / 2, UI.getGameHeight() / 2, 'bigbg');\r\n    content.push(scroll);\r\n    var map = UI.scene.add.image(UI.getGameWidth() / 2, UI.getGameHeight() / 2, 'worldmap');\r\n    content.push(map);\r\n    //map.x += 50;\r\n    map.y += 120;\r\n    map.setScale(0.4);\r\n\r\n    if (_Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].WEBGL) {\r\n        var mask = UI.scene.add.sprite(scroll.x, scroll.y, 'bigbg_mask');\r\n        mask.setVisible(false);\r\n        map.setMask(new Phaser.Display.Masks.BitmapMask(UI.scene, mask));\r\n    } else {\r\n        scroll.setScale(1.4);\r\n    }\r\n\r\n    UI.SSmap = map;\r\n    UI.SScontent = content;\r\n    _Client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].requestRegionsData();\r\n    //Client.requestCampsData();\r\n\r\n    var w = 400;\r\n    var h = 220;\r\n    var panel = new InfoPanel((UI.getGameWidth() - w) / 2, (UI.getGameHeight() - h) / 2, w, h, 'Region selection');\r\n    panel.addText(10, 15, UI.textsData['settlement_intro'], null, 14, Utils.fonts.normal);\r\n    panel.addBigButton('Got it');\r\n    panel.display();\r\n    UI.SSpanel = panel;\r\n\r\n};\r\n\r\nUI.displayRegions = function (list) {\r\n    for (var e in list.regions) {\r\n        UI.displayRegion(list.regions[e], list.world);\r\n    }\r\n};\r\n\r\nUI.displayRegion = function (data, world) {\r\n    console.log(data);\r\n    var x = (data.x / world.width) * UI.SSmap.width * UI.SSmap.scaleX - 90; // why offset?\r\n    var y = (data.y / world.height) * UI.SSmap.height * UI.SSmap.scaleY - 50;\r\n    var icon = UI.scene.add.image(x, y, 'setldiamond');\r\n    icon.setOrigin(0.5, 1);\r\n    icon.setInteractive();\r\n    UI.SScontent.push(icon);\r\n\r\n    var t = UI.scene.add.text(x, y + 12, data.name, {\r\n        font: '16px belwe',\r\n        fill: '#ffffff',\r\n        stroke: '#000000',\r\n        strokeThickness: 4\r\n    });\r\n    t.setDepth(1).setScrollFactor(0).setOrigin(0.5);\r\n    var w = t.width;\r\n    var bannerx = x - 27 - w / 2;\r\n    var bannery = y;\r\n    UI.SScontent.push(UI.scene.add.image(bannerx, bannery, 'banners', 'left').setInteractive().setOrigin(0));\r\n    UI.SScontent.push(UI.scene.add.tileSprite(bannerx + 21, bannery, w, 24, 'banners', 'middle').setInteractive().setOrigin(0));\r\n    UI.SScontent.push(UI.scene.add.image(bannerx + w + 21, bannery, 'banners', 'right').setInteractive().setOrigin(0));\r\n\r\n    UI.SScontent.push(t);\r\n\r\n    UI.scene.tweens.add({\r\n        targets: icon,\r\n        alpha: 0.2,\r\n        duration: 750,\r\n        yoyo: true,\r\n        delay: 1000,\r\n        loopDelay: 1000,\r\n        loop: -1\r\n    });\r\n\r\n    /*var w = 350;\r\n    var h = 300;\r\n    var panel = new SettlementPanel(UI.getGameWidth()-w,UI.getGameHeight()-h,w,h,data.name);\r\n    panel.setUp(data);*/\r\n\r\n    icon.setlID = data.id;\r\n\r\n    icon.on('pointerdown', function () {\r\n        if (UI.SSpanel) UI.SSpanel.hide();\r\n        //panel.display();\r\n        //UI.SSpanel = panel;\r\n        UI.selectSettlement(this.setlID);\r\n    }.bind(icon));\r\n    icon.on('pointerover', function () {\r\n        UI.tooltip.updateInfo('free', {title: data.name});\r\n        UI.tooltip.display();\r\n    });\r\n    icon.on('pointerout', function () {\r\n        UI.tooltip.hide();\r\n    });\r\n};\r\n\r\nUI.displayCamps = function (list) {\r\n    list.forEach(function (e) {\r\n        UI.displayCamp(e);\r\n    });\r\n};\r\n\r\nUI.displayCamp = function (data) {\r\n    var x = data.x * UI.SSmap.width - 50;\r\n    var y = data.y * UI.SSmap.height;\r\n    var icon = UI.scene.add.image(x, y, 'campdiamond');\r\n    icon.setScale(0.6);\r\n    icon.setOrigin(0.5, 1);\r\n    icon.setInteractive();\r\n    icon.on('pointerover', function () {\r\n        UI.tooltip.updateInfo('free', {title: 'Enemy camp'});\r\n        UI.tooltip.display();\r\n    });\r\n    icon.on('pointerout', function () {\r\n        UI.tooltip.hide();\r\n    });\r\n    UI.SScontent.push(icon);\r\n};\r\n\r\nUI.selectSettlement = function (id) {\r\n    console.log('Region selected (', id, ')');\r\n    UI.selectedSettlement = id;\r\n    var fadeDuration = 500;\r\n    UI.camera.fadeOut(fadeDuration);\r\n    UI.camera.once('camerafadeoutcomplete', function () {\r\n        UI.SScontent.forEach(function (c) {\r\n            c.setVisible(false);\r\n        });\r\n        UI.SSpanel.hide();\r\n        UI.launchGame();\r\n        UI.camera.fadeIn(fadeDuration);\r\n    });\r\n};\r\n\r\nUI.launchGame = function () {\r\n    _Boot__WEBPACK_IMPORTED_MODULE_0__[\"default\"].background.setVisible(false);\r\n    UI.scene.scene.shutdown('boot');\r\n    UI.scene.scene.launch('game');\r\n};\r\n\r\nUI.debugScreen = function () {\r\n    var graphics = UI.scene.add.graphics();\r\n    graphics.setDepth(10);\r\n    graphics.setScrollFactor(0);\r\n\r\n    graphics.lineStyle(1, 0x00ff00, 3);\r\n\r\n    graphics.beginPath();\r\n    graphics.moveTo(512, 0);\r\n    graphics.lineTo(512, 576);\r\n    graphics.strokePath();\r\n    graphics.closePath();\r\n\r\n    graphics.beginPath();\r\n    graphics.moveTo(0, 288);\r\n    graphics.lineTo(1024, 288);\r\n    graphics.strokePath();\r\n    graphics.closePath();\r\n\r\n    graphics.beginPath();\r\n    graphics.moveTo(512, 288);\r\n    graphics.lineTo(1024, 576);\r\n    graphics.strokePath();\r\n    graphics.closePath();\r\n};\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (UI);\r\n\n\n//# sourceURL=webpack:///./client/UI.js?");

/***/ }),

/***/ "./client/UICursor.js":
/*!****************************!*\
  !*** ./client/UICursor.js ***!
  \****************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _CustomSprite__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./CustomSprite */ \"./client/CustomSprite.js\");\n/* harmony import */ var _UI__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./UI */ \"./client/UI.js\");\n/**\r\n * Created by Jerome on 29-11-17.\r\n */\r\n\r\n\r\n\r\nconst UICursor = new Phaser.Class({\r\n\r\n    Extends: _CustomSprite__WEBPACK_IMPORTED_MODULE_0__[\"default\"],\r\n\r\n    initialize: function UICursor() {\r\n\r\n        _CustomSprite__WEBPACK_IMPORTED_MODULE_0__[\"default\"].call(this, _UI__WEBPACK_IMPORTED_MODULE_1__[\"default\"].scene, _UI__WEBPACK_IMPORTED_MODULE_1__[\"default\"].getGameWidth()/2, _UI__WEBPACK_IMPORTED_MODULE_1__[\"default\"].getGameHeight()/2, 'cursors','cursor');\r\n\r\n        this.setDepth(10);\r\n        this.setOrigin(0,0);\r\n\r\n        this.cursorFrames = {\r\n            default: 'cursor',\r\n            bomb: 'bombcursor',\r\n            bow: 'bow',\r\n            building: 'door',\r\n            combat: 'sabre',\r\n            gun: 'gun',\r\n            item: 'hand',\r\n            melee: 'melee',\r\n            move: 'movement'\r\n        };\r\n        // List of cursors that change appearance when the mouse is pressed\r\n        this.dualCursors = ['move', 'item', 'building', 'combat', 'melee', 'bow', 'gun'];\r\n        this.currentFrame = 'cursor'; // current frame displayed, regardless of pressed or not\r\n    },\r\n\r\n    updatePosition: function(x, y){\r\n        this.setPosition(\r\n            x,\r\n            y\r\n        );\r\n    },\r\n\r\n    changeCursor: function(cursor){\r\n        var frameKey = cursor || 'default';\r\n        this.setFrame(this.cursorFrames[frameKey]);\r\n        this.currentFrame = frameKey;\r\n    },\r\n\r\n    /**\r\n     * Called when releasing the click\r\n     */\r\n    up: function(){\r\n        if(this.dualCursors.includes(this.currentFrame)) this.setFrame(this.cursorFrames[this.currentFrame]);\r\n    },\r\n\r\n    /**\r\n     * Called when clicking; if the currently displayed cursor has a 'pressed' frame (ending in 2 in the frame names),\r\n     * then display it\r\n     */\r\n    down: function(){\r\n        if(this.dualCursors.includes(this.currentFrame)) this.setFrame(this.cursorFrames[this.currentFrame]+'2');\r\n    },\r\n\r\n    display: function () {\r\n        this.setVisible(true);\r\n    },\r\n\r\n    hide: function () {\r\n        this.setVisible(false);\r\n    }\r\n\r\n});\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (UICursor);\n\n//# sourceURL=webpack:///./client/UICursor.js?");

/***/ }),

/***/ "./client/main.js":
/*!************************!*\
  !*** ./client/main.js ***!
  \************************/
/*! no exports provided */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var phaser__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! phaser */ \"phaser\");\n/* harmony import */ var phaser__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(phaser__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _Boot__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Boot */ \"./client/Boot.js\");\n/* harmony import */ var _Engine__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./Engine */ \"./client/Engine.js\");\n/* harmony import */ var _UI__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./UI */ \"./client/UI.js\");\n\r\n\r\n\r\n\r\n\r\n\r\n// TODO: move in conf?\r\nvar VIEW_WIDTH = 32;\r\nvar VIEW_HEIGHT = 18;\r\nvar TILE_WIDTH = 32;\r\nvar TILE_HEIGHT = 32;\r\n\r\nvar config = {\r\n    //type: (navigator.userAgent.toLowerCase().indexOf('firefox') > -1 ? Phaser.CANVAS : Phaser.AUTO),\r\n    type: Phaser.WEBGL,\r\n    width: VIEW_WIDTH*TILE_WIDTH,\r\n    height: VIEW_HEIGHT*TILE_HEIGHT,\r\n    parent: 'game',\r\n    scene: [_Boot__WEBPACK_IMPORTED_MODULE_1__[\"default\"], _UI__WEBPACK_IMPORTED_MODULE_3__[\"default\"], _Engine__WEBPACK_IMPORTED_MODULE_2__[\"default\"]],\r\n    dom: {\r\n        createContainer: true\r\n      }\r\n};\r\n\r\nvar game = new Phaser.Game(config);\n\n//# sourceURL=webpack:///./client/main.js?");

/***/ }),

/***/ "./client/menuIcon.js":
/*!****************************!*\
  !*** ./client/menuIcon.js ***!
  \****************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\nvar menuIcon = function(x,y,icon,menu,tox,toy){\r\n    this.fromx = x;\r\n    this.fromy = y;\r\n    this.tox = tox;\r\n    this.toy = toy;\r\n    this.bg = UI.scene.add.sprite(x,y,'UI','holder').setScrollFactor(0).setDepth(2).setInteractive();\r\n    this.icon = UI.scene.add.sprite(x,y,'items2',icon).setScrollFactor(0).setDepth(2); // bubble down to bg\r\n    this.bg.setDepth(4);\r\n    this.icon.setDepth(5);\r\n    this.bg.on('pointerup',function(){\r\n        menu.toggle();\r\n        if(Engine.bldRect) Engine.bldUnclick(true);\r\n    });\r\n    var bg_ = this.bg;\r\n    this.bg.on('pointerover',function(){\r\n        UI.tooltip.updateInfo('free',{title:menu.name});\r\n        UI.tooltip.display();\r\n        bg_.setFrame('holder_over');\r\n    });\r\n    //this.bg.on('pointerout',UI.tooltip.hide.bind(UI.tooltip));\r\n    this.bg.on('pointerout',function(){\r\n        UI.tooltip.hide();\r\n        bg_.setFrame('holder');\r\n    });\r\n    this.displayed = true;\r\n};\r\n\r\nmenuIcon.prototype.toggle = function(){\r\n    if(this.displayed){\r\n        if(Engine.inBuilding || (Engine.currentMenu && Engine.currentMenu.fullHide)){\r\n            this.fullhide();\r\n        }else {\r\n            this.hide();\r\n        }\r\n    }else{\r\n        this.display();\r\n    }\r\n};\r\n\r\nmenuIcon.prototype.display = function(){\r\n    this.bg.setVisible(true);\r\n    this.icon.setVisible(true);\r\n    UI.scene.tweens.add(\r\n        {\r\n            targets: [this.bg,this.icon],\r\n            x: this.fromx,\r\n            y: this.fromy,\r\n            duration: 200\r\n        }\r\n    );\r\n    this.displayed = true;\r\n};\r\n\r\nmenuIcon.prototype.hide = function(){\r\n    this.displayed = false;\r\n    UI.scene.tweens.add(\r\n        {\r\n            targets: [this.bg,this.icon],\r\n            x: this.tox,\r\n            y: this.toy,\r\n            duration: 300\r\n        }\r\n    );\r\n};\r\n\r\nmenuIcon.prototype.fullhide = function(){\r\n    this.bg.setVisible(false);\r\n    this.icon.setVisible(false);\r\n    this.displayed = false;\r\n};\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (menuIcon);\n\n//# sourceURL=webpack:///./client/menuIcon.js?");

/***/ }),

/***/ "./shared/SpaceMap.js":
/*!****************************!*\
  !*** ./shared/SpaceMap.js ***!
  \****************************/
/*! exports provided: SpaceMap, SpaceMapList */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"SpaceMap\", function() { return SpaceMap; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"SpaceMapList\", function() { return SpaceMapList; });\n/**\r\n * Created by Jerome on 23-04-17.\r\n */\r\n\r\nvar onServer = (typeof window === 'undefined');\r\n\r\n// A space map is a custom data struture, similar to a sparse 2D array. Entities are stored according to their coordinates;\r\n// that is, two keys are needed to fetch entities, the x position and the y position. This allows fast look-up based on position,\r\n// e.g. var objectAtSomePosition = mySpaceMap.get(x,y);\r\nfunction SpaceMap(){}\r\n\r\nSpaceMap.prototype.add = function(x,y,object){\r\n    if(!this.hasOwnProperty(x))this[x] = {};\r\n    if(object === undefined) object = 1;\r\n    this[x][y] = object; // replaces any existing object\r\n};\r\n\r\nSpaceMap.prototype.accumulate = function(x,y,object,cb){\r\n    if(!this.hasOwnProperty(x))this[x] = {};\r\n    if(object === undefined) object = 1;\r\n    if(this[x][y]){\r\n        cb.call(this[x][y]);\r\n    }else{\r\n        this[x][y] = object;\r\n    }\r\n};\r\n\r\nSpaceMap.prototype.increment = function(x,y){\r\n    if(!this.hasOwnProperty(x))this[x] = {};\r\n    if(!this[x].hasOwnProperty(y)) this[x][y] = 0;\r\n    this[x][y]++;\r\n    return this[x][y];\r\n};\r\n\r\n// Works also by calling mySpaceMap[x][y]\r\nSpaceMap.prototype.get = function(x,y){\r\n    if(!this.hasOwnProperty(x)) return null;\r\n    if(!this[x].hasOwnProperty(y)) return null;\r\n    return this[x][y];\r\n};\r\n\r\nSpaceMap.prototype.has = function(x,y){\r\n    if(!this.hasOwnProperty(x)) return false;\r\n    return(this[x].hasOwnProperty(y));\r\n};\r\n\r\nSpaceMap.prototype.delete = function(x,y){\r\n    if(!this.hasOwnProperty(x)) return;\r\n    if(!this[x].hasOwnProperty(y)) return;\r\n    delete this[x][y];\r\n    if(Object.keys(this[x]).length == 0) delete this[x];\r\n};\r\n\r\nSpaceMap.prototype.getFirst = function(){\r\n    return this.toList()[0].v;\r\n};\r\n\r\nSpaceMap.prototype.merge = function(otherMap){\r\n    otherMap.toList().forEach(function(cell){\r\n        this.add(cell.x,cell.y);\r\n    },this);\r\n};\r\n\r\nSpaceMap.prototype.toList = function(compact,skipv){ // serialize to a list representation\r\n    var list = [];\r\n    for(var x in this){\r\n        if(this.hasOwnProperty(x)){\r\n            for(var y in this[x]){\r\n                if(this[x].hasOwnProperty(y)){\r\n                    if(compact){\r\n                        if(skipv){\r\n                            list.push([parseInt(x), parseInt(y)]);\r\n                        }else {\r\n                            list.push([parseInt(x), parseInt(y), this[x][y]]);\r\n                        }\r\n                    }else {\r\n                        if(skipv){\r\n                            list.push({\r\n                                x: x,\r\n                                y: y\r\n                            });\r\n                        }else {\r\n                            list.push({\r\n                                x: x,\r\n                                y: y,\r\n                                v: this[x][y]\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return list;\r\n};\r\n\r\nSpaceMap.prototype.fromList = function(list,compact) { // unserialize from list representation\r\n    for(var i = 0; i < list.length; i++){\r\n        var item = list[i];\r\n        if(compact){\r\n            this.add(item[0],item[1],(item[2] || {}))\r\n        }else {\r\n            this.add(item.x, item.y, (item.v || {}));\r\n        }\r\n    }\r\n};\r\n\r\nSpaceMap.prototype.toString = function(){ // serialize to a list representation\r\n    var s = \"\";\r\n    for(x in this){\r\n        if(this.hasOwnProperty(x)){\r\n            for(y in this[x]){\r\n                if(this[x].hasOwnProperty(y)) {\r\n                    s += \"(\"+x+\",\"+y+\",\"+this[x][y]+\")\";\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return s;\r\n};\r\n\r\n\r\n// ###############\r\n\r\nfunction SpaceMapList(){}\r\n\r\nSpaceMapList.prototype.add = function(x,y,object){\r\n    if(!this.hasOwnProperty(x))this[x] = {};\r\n    if(!this[x].hasOwnProperty(y)) this[x][y] = [];\r\n    if(object === undefined) object = 1;\r\n    this[x][y].push(object);\r\n};\r\n\r\n// Works also by calling mySpaceMap[x][y]\r\nSpaceMapList.prototype.get = function(x,y){\r\n    if(!this.hasOwnProperty(x)) return [];\r\n    if(!this[x].hasOwnProperty(y)) return [];\r\n    return this[x][y];\r\n};\r\n\r\nSpaceMapList.prototype.delete = function(x,y,object){\r\n    if(!this.hasOwnProperty(x)) return;\r\n    if(!this[x].hasOwnProperty(y)) return;\r\n    this[x][y].splice(this[x][y].findIndex(function(e){\r\n        return e.getShortID() == object.getShortID();\r\n    }),1);\r\n    if(Object.keys(this[x]).length == 0) delete this[x];\r\n};\r\n\r\n\n\n//# sourceURL=webpack:///./shared/SpaceMap.js?");

/***/ }),

/***/ "./shared/Stats.js":
/*!*************************!*\
  !*** ./shared/Stats.js ***!
  \*************************/
/*! exports provided: Stat, Stats, StatsContainer */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"Stat\", function() { return Stat; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"Stats\", function() { return Stats; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"StatsContainer\", function() { return StatsContainer; });\n/* harmony import */ var _Utils__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Utils */ \"./shared/Utils.js\");\n/**\r\n * Created by jeren on 10-12-17.\r\n */\r\n\r\n\r\n\r\nvar Stats = {\r\n    hpmax: {\r\n        min: 0,\r\n        max: 10000,\r\n        default: 100,\r\n        noModifier: true,\r\n        hidden: true\r\n    },\r\n    hp: {\r\n        name: 'Vitality',\r\n        desc: 'Represents how healthy you are. If it gets to 0, you die. Look for medicine to replenish.',\r\n        min: 0,\r\n        max: 10000,\r\n        default: 100,\r\n        frame: 'heart',\r\n        hasMax: 'hpmax',\r\n        noModifier: true\r\n    },\r\n    vigor: {\r\n        name: 'Vigor',\r\n        desc: 'Decreases as you perform actions and become tired. If it gets too low, it will negatively impact your other stats and disable most of your abilities. Look for shelter to replenish.',\r\n        min: 0,\r\n        max: 100,\r\n        default: 100,\r\n        noModifier: true,\r\n        frame: 'goldenheart',\r\n        suffix: '%'\r\n    },\r\n    food: {\r\n        name: 'Food',\r\n        desc: 'Decreases over time. As it gets lower, your vigor will decrease faster and faster. Look for food to replenish.',\r\n        min: 0,\r\n        max: 100,\r\n        default: 100,\r\n        noModifier: true,\r\n        frame: 'bread',\r\n        suffix: '%'\r\n    },\r\n    dmg: {\r\n        name: 'Damage',\r\n        desc: 'Offensive power of your attacks. Depends on the currently equipped weapon (melee or ranged).',\r\n        min: 0,\r\n        max: 1000,\r\n        frame: 'sword'\r\n    },\r\n    def: {\r\n        name: 'Defense',\r\n        desc: 'Resistance to all types of damage. Can be increased by several pieces of equipment.',\r\n        min: 0,\r\n        max: 1000,\r\n        frame: 'armor'\r\n    },\r\n    acc: {\r\n        name: 'Accuracy',\r\n        desc: 'Base chances to hit a target with a ranged weapon. Depends on the currently equipped ranged weapon. In battle, this number decreases based on the distance to the target.',\r\n        min: 0,\r\n        max: 100,\r\n        default: 50,\r\n        frame: 'bullseye',\r\n        suffix: '%'\r\n    }\r\n};\r\n\r\nfunction StatsContainer(){\r\n    for(var statKey in Stats){\r\n        if(!Stats.hasOwnProperty(statKey)) return;\r\n        var statData = Stats[statKey];\r\n        var max = (statData.hasMax ? this[statData.hasMax] : null);\r\n        this[statKey] = new Stat(statKey,statData.default,max);\r\n    }\r\n}\r\n\r\nStatsContainer.prototype.toList = function(){\r\n    var list = [];\r\n    for(var statKey in Stats){\r\n        if(!Stats.hasOwnProperty(statKey)) return;\r\n        list.push({stat:statKey,value:this[statKey].getBaseValue()});\r\n    }\r\n    return list;\r\n};\r\n\r\n\r\nfunction Stat(key,value,max){\r\n    this.key = key;\r\n    this.maxStat = max;\r\n    this.absoluteModifiers = [];\r\n    this.relativeModifiers = [];\r\n    this.setBaseValue(value || 0);\r\n}\r\n\r\nStat.prototype.getBaseValue = function(){\r\n    return this.baseValue;\r\n};\r\n\r\nStat.prototype.getCap = function(){\r\n    var statData = Stats[this.key];\r\n    return (this.maxStat ? Math.min(this.maxStat.getValue(),statData.max) : statData.max);\r\n};\r\n\r\nStat.prototype.clamp = function(v){\r\n    var statData = Stats[this.key];\r\n    //console.warn('clamping',this.key,'between',statData.min,this.getCap());\r\n    var c = _Utils__WEBPACK_IMPORTED_MODULE_0__[\"default\"].clamp(v,statData.min,this.getCap());\r\n    //console.warn('#',c,v,statData.min,this.getCap());\r\n    return c;\r\n};\r\n\r\nStat.prototype.getValue = function(){\r\n    var base = this.getBaseValue();\r\n    this.absoluteModifiers.forEach(function(m){\r\n        base += m;\r\n    });\r\n    this.relativeModifiers.forEach(function(m){\r\n        base *= (1+(m/100));\r\n    });\r\n    return this.clamp(Math.round(base));\r\n};\r\n\r\nStat.prototype.setBaseValue = function(value,force){\r\n    var v = (force ? value : this.clamp(value));\r\n    this.baseValue = v;\r\n};\r\n\r\nStat.prototype.increment = function(inc){\r\n    var base = this.clamp(this.getBaseValue());\r\n    this.setBaseValue(base+inc);\r\n    return (this.getBaseValue() != base); // has the value actually changed or not\r\n};\r\n\r\nStat.prototype.addAbsoluteModifier = function(modifier){\r\n    if(isNaN(modifier)) return;\r\n    this.absoluteModifiers.push(modifier);\r\n};\r\n\r\nStat.prototype.addRelativeModifier = function(modifier){\r\n    if(isNaN(modifier)) return;\r\n    this.relativeModifiers.push(modifier);\r\n};\r\n\r\n/*Stat.prototype.maximize = function(){\r\n    //console.warn('Maximizing ',this.key,' to',this.maxStat.getValue());\r\n    this.setBaseValue(this.maxStat.getValue());\r\n};*/\r\n\r\nStat.prototype.removeAbsoluteModifier = function(modifier){\r\n    var idx = this.absoluteModifiers.indexOf(modifier);\r\n    if(idx > -1) this.absoluteModifiers.splice(idx,1);\r\n};\r\n\r\nStat.prototype.removeRelativeModifier = function(modifier){\r\n    var idx = this.relativeModifiers.indexOf(modifier);\r\n    if(idx > -1) this.relativeModifiers.splice(idx,1);\r\n};\r\n\r\nStat.prototype.clearRelativeModifiers = function(){\r\n    this.relativeModifiers = [];\r\n};\r\n\r\nStat.prototype.trim = function(){\r\n      var obj = {\r\n          k: this.key,\r\n          v: this.getBaseValue(),\r\n          r: this.relativeModifiers,\r\n          a: this.absoluteModifiers\r\n      };\r\n      if(obj.r.length == 0) obj.r = undefined;\r\n      if(obj.a.length == 0) obj.a = undefined;\r\n      return obj;\r\n};\r\n\r\n\r\n\n\n//# sourceURL=webpack:///./shared/Stats.js?");

/***/ }),

/***/ "./shared/Utils.js":
/*!*************************!*\
  !*** ./shared/Utils.js ***!
  \*************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _shared_World__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../shared/World */ \"./shared/World.js\");\n/**\r\n * Created by Jerome on 11-08-17.\r\n */\r\n\r\nvar onServer = (typeof window === 'undefined');\r\n\r\n// if(onServer){\r\n//     World = require('./World.js').World;\r\n// }\r\n\r\n\r\nvar Utils = {\r\n    colors: {},\r\n    strokes: {},\r\n    fonts: {}\r\n};\r\n\r\nUtils.colors.white = '#ffffff';\r\nUtils.colors.gold = '#ffd700';\r\nUtils.colors.red = '#ff0000';\r\nUtils.colors.lightred = '#ff3b3b';\r\nUtils.colors.blue = '#558fff';\r\nUtils.strokes.red = '#331111';\r\nUtils.colors.green = '#11ee11';\r\n\r\nUtils.fonts.normal = 'arial';\r\nUtils.fonts.fancy = 'belwe';\r\n\r\n// ### Coordinates methodes ###\r\n\r\n/**\r\n * Return the AOI to which a tile belongs.\r\n * @param {Object|number} tile - {x,y} coordinates of tile, or alternatively the x coordinate only.\r\n * @param {number} y - The y coordinate of the tile.\r\n */\r\nUtils.tileToAOI = function(tile,y){\r\n    var tileX,tileY;\r\n    if(y !== undefined){\r\n        tileX = tile;\r\n        tileY = y;\r\n    }else{\r\n        tileX = tile.x;\r\n        tileY = tile.y;\r\n    }\r\n    if(!_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal) throw Error('Chunk data not initialized');\r\n    tileX = Utils.clamp(tileX,0,_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].worldWidth-1);\r\n    tileY = Utils.clamp(tileY,0,_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].worldHeight-1);\r\n    var top = Math.floor(tileY/_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkHeight);\r\n    var left = Math.floor(tileX/_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkWidth);\r\n    return (top*_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal)+left;\r\n};\r\n\r\nUtils.AOItoTile = function(aoi){\r\n    if(!_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal) throw Error('Chunk data not initialized');\r\n    return {\r\n        x : (aoi%_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal)*_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkWidth,\r\n        y : Math.floor(aoi/_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal)*_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkHeight\r\n    };\r\n};\r\n\r\nUtils.getAOIcorners = function(aoi){\r\n    // Returns in order: tl, tr, br, bl\r\n    var l = [];\r\n    var o = Utils.AOItoTile(aoi);\r\n    l.push(o);\r\n    l.push({x:o.x+_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkWidth,y:o.y});\r\n    l.push({x:o.x+_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkWidth,y:o.y+_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkHeight});\r\n    l.push({x:o.x,y:o.y+_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].chunkHeight});\r\n    return l;\r\n};\r\n\r\nUtils.gridToLine = function(x,y,w){\r\n    return (y*w)+x;\r\n};\r\n\r\nUtils.gridToLineWithOrigin = function(x,y,w){\r\n    var aoi = Utils.tileToAOI({x:x,y:y});\r\n    var origin = Utils.AOItoTile(aoi);\r\n    return Utils.gridToLine(x-origin.x,y-origin.y,w);\r\n};\r\n\r\nUtils.lineToGrid = function(i,w){\r\n    return {\r\n        x: i%w,\r\n        y: Math.floor(i/w)\r\n    }\r\n};\r\n\r\nUtils.tileToPct = function(x,y){\r\n    return {\r\n        x : x / _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].worldWidth,\r\n        y : y / _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].worldHeight\r\n    }\r\n};\r\n\r\nUtils.pctToTile = function(x,y){\r\n    return {\r\n        x : x * _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].worldWidth,\r\n        y : y * _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].worldHeight\r\n    }\r\n};\r\n\r\nUtils.screenToMap = function(x,y,map){\r\n    var tlx = map.x - map.displayOriginX; // top left of map\r\n    var tly = map.y - map.displayOriginY;\r\n    console.log(x,y,tlx,tly);\r\n    return {\r\n        x: x - tlx,\r\n        y: y - tly\r\n    }\r\n};\r\n\r\n// ### Quadrant-related methods ###\r\n\r\nUtils.AOIcoordinates = function(aoi){\r\n    return {\r\n        x : (aoi%_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal),\r\n        y : Math.floor(aoi/_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal)\r\n    }\r\n};\r\n\r\nUtils.distanceBetweenAOIs = function(A,B){\r\n    return Utils.manhattan(Utils.AOIcoordinates(A),Utils.AOIcoordinates(B));\r\n};\r\n\r\nUtils.tileToQuadrant = function(x,y,quadW,quadH){\r\n    if(!quadW) quadW = 10;\r\n    if(!quadH) quadH = 10;\r\n    var aoi = Utils.tileToAOI({x:x,y:y});\r\n    return Utils.aoiToQuadrant(aoi,quadW,quadH);\r\n};\r\n\r\nUtils.aoiToQuadrant = function(aoi,quadW,quadH){\r\n    var aoiCoords = Utils.lineToGrid(aoi,_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    var nbQuadsHorizontal = Math.ceil(_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal/quadW);\r\n    var top = Math.floor(aoiCoords.y/quadH);\r\n    var left = Math.floor(aoiCoords.x/quadW);\r\n    return (top*nbQuadsHorizontal)+left;\r\n};\r\n\r\nUtils.distanceToPoles = function(x,y,poles){\r\n    var aoi = Utils.tileToAOI({x:x,y:y});\r\n    var aoicoord = Utils.lineToGrid(aoi,_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    var dists = []; // distances (in aoi) between tile and each pole\r\n    var sum = 0;\r\n    for(var i = 0; i < poles.length; i++){\r\n        var d = Utils.euclidean(\r\n            aoicoord,\r\n            Utils.lineToGrid(poles[i],_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal)\r\n        );\r\n        if(d == 0) d = 0.1;\r\n        d *= d; // polarizes more\r\n        sum += d;\r\n        dists.push(d);\r\n    }\r\n    //console.log('distances :', dists, 'sum = ',sum);\r\n\r\n    // Revert: d' = sum/d\r\n    var sumweights = 0;\r\n    var weights = dists.map(function(d){\r\n        //var w = (d > 0 ? sum/d : 1);\r\n        var w = sum/d;\r\n        sumweights += w;\r\n        return w;\r\n    });\r\n    //console.log('weights :', weights);\r\n\r\n    // Normalize: z = d'/sum'\r\n    var normalized = weights.map(function(w){\r\n        var w = Math.round((w/sumweights)*10);\r\n        if(w <= 2) w = 0;\r\n        return w;\r\n    });\r\n    //console.log('normalized :', normalized);\r\n    return normalized;\r\n};\r\n\r\n\r\n// ### General methods ###\r\n\r\nUtils.listAdjacentAOIs = function(current){\r\n    if(!_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal){\r\n        console.log('ERROR : Chunk data not initialized');\r\n        return [];\r\n    }\r\n\r\n    var AOIs = [];\r\n    var isAtTop = (current < _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    var isAtBottom = (current > _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].lastChunkID - _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    var isAtLeft = (current%_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal == 0);\r\n    var isAtRight = (current%_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal == _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal-1);\r\n    AOIs.push(current);\r\n    if(!isAtTop) AOIs.push(current - _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    if(!isAtBottom) AOIs.push(current + _shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    if(!isAtLeft) AOIs.push(current-1);\r\n    if(!isAtRight) AOIs.push(current+1);\r\n    if(!isAtTop && !isAtLeft) AOIs.push(current-1-_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    if(!isAtTop && !isAtRight) AOIs.push(current+1-_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    if(!isAtBottom && !isAtLeft) AOIs.push(current-1+_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    if(!isAtBottom && !isAtRight) AOIs.push(current+1+_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].nbChunksHorizontal);\r\n    return AOIs;\r\n};\r\n\r\nUtils.listNeighborsInGrid = function(current,width,height,offset){\r\n    offset = (offset || 1);\r\n    var nbh = [current];\r\n    var isAtTop = (current < width);\r\n    var isAtBottom = (current > ((width*height)-1) - width);\r\n    var isAtLeft = (current%width == 0);\r\n    var isAtRight = (current%width == width-1);\r\n    if(!isAtTop) nbh.push(current - width);\r\n    if(!isAtBottom) nbh.push(current + width);\r\n    if(!isAtLeft) nbh.push(current-(1*offset));\r\n    if(!isAtRight) nbh.push(current+(1*offset));\r\n    if(!isAtTop && !isAtLeft) nbh.push(current-(1*offset)-width);\r\n    if(!isAtTop && !isAtRight) nbh.push(current+(1*offset)-width);\r\n    if(!isAtBottom && !isAtLeft) nbh.push(current-(1*offset)+width);\r\n    if(!isAtBottom && !isAtRight) nbh.push(current+(1*offset)+width);\r\n    return nbh;\r\n}\r\n\r\nUtils.formatMoney = function(nb){\r\n    return 'coin'+(nb > 1 ? 's' : '');\r\n};\r\n\r\nUtils.euclidean = function(a,b){\r\n    //console.log('dist between',a,b);\r\n    return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y- b.y,2));\r\n};\r\n\r\nUtils.chebyshev = function(A,B){\r\n    return Math.max(Math.abs(A.x-B.x),Math.abs(A.y-B.y));\r\n};\r\n\r\nUtils.nextTo = function(a,b){\r\n    a = a.getRect();\r\n    b = b.getRect();\r\n    return Utils.overlap(a,b,true);\r\n};\r\n\r\nUtils.overlap = function(a,b,touch){\r\n    if(touch){ // touching counts as overlapping\r\n        if(a.x > b.x + b.w || b.x > a.x + a.w) return false;\r\n        if(a.y > b.y + b.h || b.y > a.y + a.h) return false;\r\n    }else{\r\n        if(a.x >= b.x + b.w || b.x >= a.x + a.w) return false;\r\n        if(a.y >= b.y + b.h || b.y >= a.y + a.h) return false;\r\n    }\r\n    return true;\r\n};\r\n\r\nUtils.getBoxCenter = function(box){\r\n    return {\r\n        x: box.x + (box.w/2),\r\n        y: box.y + (box.h/2)\r\n    }\r\n};\r\n\r\nUtils.boxesDistance = function(a,b){\r\n    var ca = Utils.getBoxCenter(a);\r\n    var cb = Utils.getBoxCenter(b);\r\n    var dx = Math.max(0,Math.abs(ca.x-cb.x) - (a.w/2) - (b.w/2));\r\n    var dy = Math.max(0,Math.abs(ca.y-cb.y) - (a.h/2) - (b.h/2));\r\n    //console.warn(dx,dy);\r\n    return dx+dy;\r\n};\r\n\r\n/*Utils.multiChebcomponent = function(A,B,coord,length){\r\n    return Math.min(\r\n        Math.abs(A[coord]-B[coord]),\r\n        Math.abs(A[coord]+A[length]-B[coord]),\r\n        Math.abs(A[coord]-(B[coord]+B[length])),\r\n        Math.abs(A[coord]+A[length]-(B[coord]+B[length]))\r\n    );\r\n};\r\n\r\n// a & b should be rectangles, i.e. expose x, y, w and h\r\nUtils.multiTileChebyshev = function(A,B){\r\n    return Math.max(Utils.multiChebcomponent(A,B,'x','w'),Utils.multiChebcomponent(A,B,'y','h'));\r\n};*/\r\n\r\n// With respect to B\r\nUtils.relativePosition = function(A,B){\r\n    return {\r\n        x: Math.sign(B.x-A.x),\r\n        y: Math.sign(B.y-A.y)\r\n    }\r\n};\r\n\r\nUtils.manhattan = function(a,b){\r\n    return Math.abs(a.x - b.x) + Math.abs(a.y - b.y);\r\n};\r\n\r\nUtils.multiTileManhattan = function(A,B){\r\n    var dx = Math.min(\r\n        Math.abs(A.x-B.x),\r\n        Math.abs(A.x+A.w-B.x),\r\n        Math.abs(A.x-(B.x+B.w)),\r\n        Math.abs(A.x+A.w-(B.x+B.w))\r\n    );\r\n    var dy = Math.min(\r\n        Math.abs(A.y-B.y),\r\n        Math.abs(A.y+A.h-B.y),\r\n        Math.abs(A.y-(B.y+B.h)),\r\n        Math.abs(A.y+A.h-(B.y+B.h))\r\n    );\r\n    return Math.abs(dx)+Math.abs(dy);\r\n};\r\n\r\nUtils.clamp = function(x,min,max){ // restricts a value to a given interval (return the value unchanged if within the interval\r\n    return Math.max(min, Math.min(x, max));\r\n};\r\n\r\nUtils.randomInt = function(low, high) { // [low, high]\r\n    high++;\r\n    return Math.floor(Math.random() * (high - low) + low);\r\n};\r\n\r\nUtils.randomElement = function(arr){\r\n    return arr[Math.floor(Math.random()*arr.length)];\r\n};\r\n\r\nUtils.randomElementRemoved = function(arr){\r\n    return arr.splice(Math.floor(Math.random()*arr.length),1)[0];\r\n};\r\n\r\nUtils.randomNorm = function(mean,std){ // Returns a value from a normal distribution\r\n    return randomZ()*std+mean;\r\n};\r\n\r\nfunction randomZ() { // Box-Muller transform to return a random value from a reduced normal\r\n    var u = 0, v = 0;\r\n    while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)\r\n    while(v === 0) v = Math.random();\r\n    return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );\r\n}\r\n\r\nUtils.swapElements = function(arr,b,c){\r\n    var tmp = arr[b];\r\n    arr[b] = arr[c];\r\n    arr[c] = tmp;\r\n};\r\n\r\nUtils.removeElement = function(v,arr){\r\n    var idx = arr.indexOf(v);\r\n    if(idx > -1) arr.splice(idx,1);\r\n};\r\n\r\nUtils.insert = function(a1,a2,pos){ // insert array a2 at position pos in array a1\r\n    a1.splice.apply(a1, [pos, 0].concat(a2));\r\n};\r\n\r\nUtils.shuffle = function(array) {\r\n    for (var i = array.length - 1; i > 0; i--) {\r\n        var j = Math.floor(Math.random() * (i + 1));\r\n        var temp = array[i];\r\n        array[i] = array[j];\r\n        array[j] = temp;\r\n    }\r\n};\r\n\r\nUtils.indexOfMax = function(arr) {\r\n    if (arr.length === 0) return -1;\r\n    var max = arr[0];\r\n    var maxIndex = 0;\r\n    for (var i = 1; i < arr.length; i++) {\r\n        if (arr[i] > max) {\r\n            maxIndex = i;\r\n            max = arr[i];\r\n        }\r\n    }\r\n    return maxIndex;\r\n};\r\n\r\nUtils.printArray = function(arr){\r\n    console.log(JSON.stringify(arr));\r\n};\r\n\r\nUtils.capitalizeFirstLetter = function(string) {\r\n    return string.charAt(0).toUpperCase() + string.slice(1);\r\n};\r\n\r\nfunction coordinatesPairToTile(coords){\r\n    return {\r\n        x: Math.floor(coords.x/_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].tileWidth),\r\n        y: Math.floor(coords.y/_shared_World__WEBPACK_IMPORTED_MODULE_0__[\"default\"].tileHeight)\r\n    }\r\n}\r\n\r\nfunction coordinatesToCell(v,grid){\r\n    return Math.floor(v/grid);\r\n}\r\n\r\nUtils.computeSpeed = function(angle){ // return unit speed vector given an angle\r\n    return {\r\n        x: Math.cos(angle),\r\n        y: -Math.sin(angle)\r\n    }\r\n};\r\n\r\nArray.prototype.diff = function(a) { // returns the elements in the array that are not in array a\r\n    return this.filter(function(i) {return a.indexOf(i) < 0;});\r\n};\r\n\r\nArray.prototype.last = function(){\r\n    return this[this.length-1];\r\n};\r\n\r\nArray.prototype.rotate = function( n ) {\r\n    this.unshift.apply( this, this.splice( n, this.length ) );\r\n    return this;\r\n};\r\n\r\nArray.prototype.previous = function(i){\r\n    return (i > 0 ? this[i-1] : this.last());\r\n};\r\n\r\nif (typeof Object.assign !== 'function') {\r\n    // Must be writable: true, enumerable: false, configurable: true\r\n    Object.defineProperty(Object, \"assign\", {\r\n        value: function assign(target, varArgs) { // .length of function is 2\r\n            'use strict';\r\n            if (target === null || target === undefined) {\r\n                throw new TypeError('Cannot convert undefined or null to object');\r\n            }\r\n\r\n            var to = Object(target);\r\n\r\n            for (var index = 1; index < arguments.length; index++) {\r\n                var nextSource = arguments[index];\r\n\r\n                if (nextSource !== null && nextSource !== undefined) {\r\n                    for (var nextKey in nextSource) {\r\n                        // Avoid bugs when hasOwnProperty is shadowed\r\n                        if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\r\n                            to[nextKey] = nextSource[nextKey];\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return to;\r\n        },\r\n        writable: true,\r\n        configurable: true\r\n    });\r\n}\r\n\r\n// if (onServer) module.exports.Utils = Utils;\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (Utils);\n\n//# sourceURL=webpack:///./shared/Utils.js?");

/***/ }),

/***/ "./shared/World.js":
/*!*************************!*\
  !*** ./shared/World.js ***!
  \*************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/**\r\n * Created by Jerome on 14-10-17.\r\n */\r\n\r\nvar World = {};\r\n\r\nWorld.setUp = function(nbHoriz,nbVert,chunkW,chunkH,tileW,tileH){\r\n    World.nbChunksHorizontal = nbHoriz;\r\n    World.nbChunksVertical = nbVert;\r\n    World.chunkWidth = chunkW;\r\n    World.chunkHeight = chunkH;\r\n    World.tileWidth = tileW || 32;\r\n    World.tileHeight = tileH || 32;\r\n    World.computeProperties();\r\n};\r\n\r\nWorld.readMasterData = function(data){\r\n    World.setUp(\r\n        data.nbChunksHoriz,data.nbChunksVert,\r\n        data.chunkWidth,data.chunkHeight\r\n    );\r\n};\r\n\r\nWorld.computeProperties = function(){\r\n    World.worldWidth = World.chunkWidth*World.nbChunksHorizontal;\r\n    World.worldHeight = World.chunkHeight*World.nbChunksVertical;\r\n    World.lastChunkID = World.nbChunksHorizontal*World.nbChunksVertical - 1;\r\n    console.log('Set up world of size '+World.worldWidth+' x '+World.worldHeight);\r\n};\r\n\r\n/* harmony default export */ __webpack_exports__[\"default\"] = (World);\n\n//# sourceURL=webpack:///./shared/World.js?");

/***/ }),

/***/ "phaser":
/*!*************************!*\
  !*** external "phaser" ***!
  \*************************/
/*! no static exports found */
/***/ (function(module, exports) {

eval("module.exports = require(\"phaser\");\n\n//# sourceURL=webpack:///external_%22phaser%22?");

/***/ })

/******/ });